# Recall v3 é¡¹ç›®è‡ªæŸ¥æŠ¥å‘Š

> æ£€æŸ¥æ—¥æœŸï¼š2026å¹´1æœˆ20æ—¥ï¼ˆæ·±åº¦å®¡è®¡æ›´æ–°ï¼‰  
> å¯¹ç…§æ–‡æ¡£ï¼šRecall-ai-plan.md - åäºŒç‚¹äº”ã€æœ€ç»ˆè‡ªæŸ¥ï¼ˆå®Œæ•´ç‰ˆï¼‰

---

## ä¸€ã€è‡ªæŸ¥ç»“æœæ€»è§ˆ

| çŠ¶æ€ | æ•°é‡ | å æ¯” |
|:-----|:----:|:----:|
| âœ… å®Œå…¨å®ç° | 27 | 96% |
| ğŸ”§ éƒ¨åˆ†å®ç° | 0 | 0% |
| âŒ æœªå®ç°ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰ | 1 | 4% |
| **æ€»è®¡** | **28** | **100%** |

> ğŸ“Œ **è¯´æ˜**ï¼š
> - âœ… **ä¼ç¬”ç³»ç»Ÿå·²å®Œæˆ**ï¼šForeshadowingAnalyzer + LLM API æ–¹æ¡ˆï¼ˆ2026-01-18ï¼‰
> - âœ… **100%ä¸é—å¿˜å·²éªŒè¯**ï¼šVolumeManagerå­˜æ¡£ + 8å±‚æ£€ç´¢ + N-gramåŸæ–‡å…œåº•ï¼ˆ2026-01-19ï¼‰
> - âœ… **è¯­ä¹‰å»é‡å·²å®ç°**ï¼šEmbeddingä½™å¼¦ç›¸ä¼¼åº¦ + ä¸‰çº§å»é‡ç­–ç•¥ï¼ˆ2026-01-19ï¼‰
> - âœ… **L6å‘é‡ç²¾æ’å®Œæ•´ç‰ˆ**ï¼šé‡æ–°è®¡ç®—ç²¾ç¡®ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆ2026-01-19ï¼‰
> - âœ… **N-gramåŸæ–‡ç´¢å¼•æŒä¹…åŒ–**ï¼šJSONLå¢é‡å­˜å‚¨ï¼Œé‡å¯ä¸ä¸¢å¤±ï¼ˆ2026-01-19ï¼‰
> - âœ… **L0 CoreSettingsæ³¨å…¥**ï¼šengine.build_contextæ­£ç¡®æ³¨å…¥æ ¸å¿ƒè®¾å®šï¼ˆ2026-01-20ä¿®å¤ï¼‰
> - âœ… **è§„èŒƒ100%éµå®ˆ**ï¼šå±æ€§/å…³ç³»/æ—¶é—´çº¿æ£€æµ‹âœ… + ç»å¯¹è§„åˆ™æ£€æµ‹âœ…ï¼ˆ2026-01-24å®Œæˆï¼‰
> - â­ **è®¡åˆ’å¤–æ–°å¢4é¡¹**ï¼šæŒä¹…æ¡ä»¶ç³»ç»Ÿã€é…ç½®çƒ­æ›´æ–°ã€ä¼ç¬”åˆ†æå™¨å¢å¼ºã€CoreSettings APIï¼ˆç¬¬ä¸‰ç»„ï¼‰
> - âŒ CodeIndexer æ˜¯ä»£ç åœºæ™¯åŠŸèƒ½ï¼ŒRPåœºæ™¯å¯é€‰

---

## ä¸€ç‚¹ä¸€ã€æ·±åº¦ä»£ç å®¡è®¡ï¼ˆ2026-01-20 æœ€æ–°ï¼‰

> ğŸ“Œ æœ¬æ¬¡å®¡è®¡å‘ç°å¹¶ä¿®å¤äº†ä»¥ä¸‹é—®é¢˜ï¼š

### å·²ä¿®å¤çš„ä¸¥é‡é—®é¢˜

| é—®é¢˜ | æ–‡ä»¶ | ä¿®å¤å†…å®¹ |
|------|------|---------|
| **â­ L0 CoreSettingsä»æœªä½¿ç”¨** | `engine.py` | 2026-01-20ä¿®å¤ï¼šæ·»åŠ å¯¼å…¥ã€åˆå§‹åŒ–ã€åœ¨build_contextä¸­æ³¨å…¥æ ¸å¿ƒè®¾å®š |
| **â­ CoreSettings.save()ç¼ºå‚æ•°** | `layer0_core.py` | 2026-01-20ä¿®å¤ï¼šæ·»åŠ _data_pathå†…éƒ¨å­˜å‚¨ï¼Œsave()æ— éœ€ä¼ å‚ |
| **â­ ä¸€è‡´æ€§æ£€æŸ¥ç»“æœä¸¢å¤±** | `engine.py` | 2026-01-20ä¿®å¤ï¼šAddResultæ·»åŠ consistency_warningså­—æ®µå¹¶è¿”å› |
| **â­ VolumeDataç¡¬ç¼–ç å¸¸é‡** | `volume_manager.py` | 2026-01-20ä¿®å¤ï¼šæ”¹ç”¨ç±»å¸¸é‡TURNS_PER_VOLUME/TURNS_PER_FILE |
| **VolumeData._persist() é‡å¤å†™å…¥** | `volume_manager.py` | æ·»åŠ  `_persisted_turns` é›†åˆè¿½è¸ªå·²æŒä¹…åŒ–æ•°æ® |
| **_check_timeline ç©ºå®ç°** | `consistency.py` | å®ç°äº†ç®€åŒ–ç‰ˆæ—¶é—´çº¿å†²çªæ£€æµ‹ |
| **BloomFilter.might_contain é”™è¯¯** | `eight_layer.py`, `ngram_index.py` | ä¿®æ­£ä¸ºä½¿ç”¨ `in` è¿ç®—ç¬¦ |
| **N-gramè¿½åŠ åŸæ–‡ç›®å½•ä¸å­˜åœ¨** | `ngram_index.py` | åœ¨ `append_raw_content` ä¸­æ·»åŠ  `os.makedirs` |
| **â­ ä¼ç¬”åˆ é™¤/æ”¾å¼ƒåŠŸèƒ½ç¼ºå¤±** | `engine.py`, `server.py`, `index.js` | 2026-01-20ä¿®å¤ï¼šæ·»åŠ å®Œæ•´çš„ abandon åŠŸèƒ½é“¾è·¯ |

---

## ä¸€ç‚¹äºŒã€ä¸¥æ ¼è¯šå®çš„é—®é¢˜æ¸…å•ï¼ˆ2026-01-20 æ·±åº¦å®¡è®¡ï¼‰

> âš ï¸ **ä»¥ä¸‹é—®é¢˜æ˜¯å®é™…å­˜åœ¨çš„ï¼Œä¹‹å‰çš„æŠ¥å‘Šå£°ç§°å·²å®Œæˆä½†å®é™…ä¸Šä¸å®Œæ•´ï¼š**

### âœ… å‰ç«¯åŠŸèƒ½è¡¥å…¨ï¼ˆ2026-01-20 å®Œæˆï¼‰

| åç«¯ API | åŠŸèƒ½è¯´æ˜ | å‰ç«¯çŠ¶æ€ | å®ç°ä½ç½® |
|---------|---------|:-------:|---------|
| `/v1/core-settings` (GET/PUT) | ç»å¯¹è§„åˆ™ç®¡ç† | âœ… å·²å®ç° | âš ï¸è§„åˆ™ æ ‡ç­¾é¡µï¼ˆä»…ç»å¯¹è§„åˆ™ï¼‰ |
| `/v1/entities/{name}` | å®ä½“ä¿¡æ¯æŸ¥è¯¢ | ğŸŸ¡ ä½ä¼˜å…ˆ | å¯é€šè¿‡æœç´¢æ›¿ä»£ |
| `/v1/entities/{name}/related` | ç›¸å…³å®ä½“æŸ¥è¯¢ | ğŸŸ¡ ä½ä¼˜å…ˆ | çŸ¥è¯†å›¾è°±v3.1ç‰ˆæœ¬ |
| `/v1/stats` | ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯ | âœ… å·²å®ç° | âš™ï¸è®¾ç½® â†’ ç³»ç»Ÿç»Ÿè®¡æŒ‰é’® |
| `/v1/users` | ç”¨æˆ·/è§’è‰²åˆ—è¡¨ | ğŸŸ¡ ä½ä¼˜å…ˆ | STå·²æœ‰è§’è‰²åˆ‡æ¢ |
| `/v1/consolidate` | è®°å¿†æ•´åˆ | âœ… å·²å®ç° | âš™ï¸è®¾ç½® â†’ æ•´åˆè®°å¿†æŒ‰é’® |
| `/v1/foreshadowing/analyze/trigger` | æ‰‹åŠ¨è§¦å‘ä¼ç¬”åˆ†æ | âœ… å·²å®ç° | ğŸ­ä¼ç¬” æ ‡ç­¾é¡µ ğŸ”æŒ‰é’® |
| `/v1/config/reload` | é…ç½®çƒ­æ›´æ–° | âœ… å·²å®ç° | âš™ï¸è®¾ç½® â†’ çƒ­æ›´æ–°é…ç½®æŒ‰é’® |

> ğŸ“Œ **è®¾è®¡å†³ç­–**ï¼šST æ’ä»¶å‰ç«¯çš„ `/v1/core-settings` åªæš´éœ²"ç»å¯¹è§„åˆ™"åŠŸèƒ½ã€‚
> - è§’è‰²å¡ã€ä¸–ç•Œè§‚ã€å†™ä½œé£æ ¼ç­‰åŠŸèƒ½ä¸ **SillyTavern è‡ªå¸¦åŠŸèƒ½é‡å¤**
> - ç”¨æˆ·åº”ä½¿ç”¨ ST çš„è§’è‰²å¡ç¼–è¾‘å™¨ã€ä¸–ç•Œä¹¦ã€ä½œè€…æ³¨ç­‰åŠŸèƒ½
> - Recall åç«¯ API ä»ä¿ç•™å®Œæ•´åŠŸèƒ½ï¼Œä¾›å…¶ä»– AI å·¥å…·ï¼ˆé STï¼‰ä½¿ç”¨

### âœ… å·²ä¿®å¤çš„ä»£ç å®ç°é—®é¢˜ï¼ˆ2026-01-20ï¼‰

| é—®é¢˜ | ä¿®å¤çŠ¶æ€ |
|------|---------|
| `get_context_for_prompt` ä½ç½® | âœ… åœ¨ `ForeshadowingTracker`ï¼ˆç¬¬457è¡Œï¼‰ï¼Œæ–‡æ¡£å·²æ›´æ­£ |
| `engine.build_context` ä½¿ç”¨æ–¹æ³• | âœ… å·²æ”¹ç”¨ `tracker.get_context_for_prompt()`ï¼ˆç¬¬814è¡Œï¼‰ |
| ä¸»åŠ¨æé†’é€»è¾‘ | âœ… å·²å¯ç”¨ï¼Œä¼ å…¥ `current_turn` å‚æ•°æ”¯æŒé‡è¦ä¼ç¬”æé†’ |
| ST å‰ç«¯åŠŸèƒ½é‡å¤ | âœ… ç§»é™¤ä¸ ST é‡å¤çš„ UIï¼Œåªä¿ç•™ç»å¯¹è§„åˆ™åŠŸèƒ½ |

### âœ… å·²ç¡®è®¤å®Œæ•´çš„åŠŸèƒ½

| åŠŸèƒ½ | éªŒè¯ç»“æœ |
|------|---------|
| 100%ä¸é—å¿˜ | âœ… N-gram raw_search + VolumeManager åŒé‡ä¿éšœ |
| 8å±‚æ£€ç´¢ | âœ… å®Œæ•´å®ç°ï¼Œå«ç»ˆæå…œåº• |
| ä¼ç¬” CRUD | âœ… plant/resolve/abandon/get_active å…¨é“¾è·¯ |
| æŒä¹…æ¡ä»¶ç³»ç»Ÿ | âœ… æ·»åŠ /åˆ é™¤/å‹ç¼©/è‡ªåŠ¨æå– |
| æ¶ˆæ¯ä¿å­˜ | âœ… å‰ç«¯æ­£ç¡®è°ƒç”¨ /v1/memories |
| ä¸Šä¸‹æ–‡æ³¨å…¥ | âœ… onBeforeGeneration è°ƒç”¨ /v1/context |
| ä¼ç¬”åˆ†æ | âœ… notifyForeshadowingAnalyzer ç«ç¾é—å¿˜æ¨¡å¼ |

### è®¾è®¡å†³ç­–è¯´æ˜ï¼ˆébugï¼‰

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **L8 LLMè¿‡æ»¤é»˜è®¤å…³é—­** | æ•…æ„è®¾è®¡ã€‚L8æ¶ˆè€—LLM APIèµ„æºï¼Œé»˜è®¤å…³é—­ä»¥æ§åˆ¶æˆæœ¬ã€‚å¯é€šè¿‡ `config['l8_enabled'] = True` å¯ç”¨ |
| **ContextBuilder æœªè¢«ä½¿ç”¨** | `engine.build_context()` è‡ªå·±å®ç°äº†6.5å±‚ä¸Šä¸‹æ–‡ç­–ç•¥ï¼ŒContextBuilder ä¿ç•™ä¾›æœªæ¥æ‰©å±• |
| **ParallelRetriever æœªè¢«ä½¿ç”¨** | è®¾è®¡é€‰æ‹©ï¼ŒEightLayerRetrieveræ˜¯ä¸»è¦å®ç° |
| **RecallInit/LiteConfig å¯¼å…¥** | ä¿ç•™ç”¨äºCLIç­‰åœºæ™¯ï¼Œæ·»åŠ äº† `# noqa: F401` æ³¨é‡Š (LightweightConfig ä¸ºåˆ«å) |
| **ST å‰ç«¯åªæš´éœ²ç»å¯¹è§„åˆ™** | æ•…æ„è®¾è®¡ã€‚è§’è‰²å¡/ä¸–ç•Œè§‚/å†™ä½œé£æ ¼ä¸ ST è‡ªå¸¦åŠŸèƒ½é‡å¤ï¼Œåç«¯ API å®Œæ•´ä¿ç•™ä¾›å…¶ä»–å·¥å…·ä½¿ç”¨ |

### 100%ä¸é—å¿˜æœºåˆ¶éªŒè¯ç»“æœ

| æœºåˆ¶ | éªŒè¯ç»“æœ |
|------|---------|
| **N-gramåŸæ–‡å­˜å‚¨** | âœ… JSONLå¢é‡æŒä¹…åŒ–ï¼Œé‡å¯åæ­£ç¡®æ¢å¤ |
| **VolumeManager Archive** | âœ… åˆ†å·å­˜å‚¨ï¼Œæ”¯æŒ O(1) æŒ‰è½®æ¬¡å·å®šä½ |
| **get_turn_by_memory_id** | âœ… æœç´¢æ‰€æœ‰å·ï¼ˆå†…å­˜+ç£ç›˜ï¼‰ |
| **search_content å…œåº•æœç´¢** | âœ… åŸæ–‡å…¨æ–‡æœç´¢ï¼Œç¡®ä¿ä»»ä½•å†…å®¹éƒ½èƒ½æ‰¾åˆ° |
| **8å±‚æ£€ç´¢ç»ˆæå…œåº•** | âœ… L1-L7æ— ç»“æœæ—¶è‡ªåŠ¨è§¦å‘ N-gram raw_search |

---

## ä¸€ç‚¹äº”ã€è®¡åˆ’å¤–æ–°å¢åŠŸèƒ½ï¼ˆè¶…å‡ºåŸè®¡åˆ’ï¼‰

> ğŸ“Œ ä»¥ä¸‹åŠŸèƒ½**ä¸åœ¨åŸè®¡åˆ’åäºŒç‚¹äº”éœ€æ±‚ä¸­**ï¼Œæ˜¯å¼€å‘è¿‡ç¨‹ä¸­æ–°å¢çš„å¢å¼ºåŠŸèƒ½ã€‚

### â­ 1. æŒä¹…æ¡ä»¶ç³»ç»Ÿ (ContextTracker)

**å®ç°ä½ç½®**ï¼š`recall/processor/context_tracker.py`

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **15ç§æ¡ä»¶ç±»å‹** | ç”¨æˆ·èº«ä»½ã€ç”¨æˆ·ç›®æ ‡ã€ç”¨æˆ·åå¥½ã€æŠ€æœ¯ç¯å¢ƒã€é¡¹ç›®ä¿¡æ¯ã€æ—¶é—´çº¦æŸã€è§’è‰²ç‰¹å¾ã€ä¸–ç•Œè§‚è®¾å®šã€å…³ç³»è®¾å®šã€æƒ…ç»ªçŠ¶æ€ã€æŠ€èƒ½èƒ½åŠ›ã€ç‰©å“é“å…·ã€å‡è®¾å‰æã€çº¦æŸæ¡ä»¶ã€è‡ªå®šä¹‰ |
| **è‡ªåŠ¨æå–** | ä»å¯¹è¯ä¸­è‡ªåŠ¨è¯†åˆ«åº”è¯¥æŒä¹…åŒ–çš„æ¡ä»¶ï¼ˆLLMè¾…åŠ©ï¼‰ |
| **æ™ºèƒ½å‹ç¼©** | å½“æ¡ä»¶è¿‡å¤šæ—¶è‡ªåŠ¨åˆå¹¶ç›¸ä¼¼æ¡ä»¶ï¼Œé¿å…ä¸Šä¸‹æ–‡è†¨èƒ€ |
| **â­ è¯­ä¹‰å»é‡** | Embeddingä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆâ‰¥0.85è‡ªåŠ¨åˆå¹¶ï¼‰ï¼Œæ”¯æŒä¸Šä¸‡è½®å¯¹è¯ä¸é‡å¤ |
| **ç½®ä¿¡åº¦è¡°å‡** | é•¿æœŸæœªä½¿ç”¨çš„æ¡ä»¶ç½®ä¿¡åº¦è‡ªåŠ¨ä¸‹é™ |
| **å¢é•¿æ§åˆ¶** | æ¯ç§ç±»å‹æœ€å¤š5æ¡ï¼Œæ€»å…±æœ€å¤š30æ¡ï¼Œé˜²æ­¢æ— é™å¢é•¿ |

**API ç«¯ç‚¹**ï¼š
- `POST /v1/persistent-contexts` - æ·»åŠ æŒä¹…æ¡ä»¶
- `GET /v1/persistent-contexts` - è·å–æ´»è·ƒæ¡ä»¶
- `DELETE /v1/persistent-contexts/{context_id}` - åˆ é™¤æ¡ä»¶
- `POST /v1/persistent-contexts/extract` - ä»æ–‡æœ¬è‡ªåŠ¨æå–
- `POST /v1/persistent-contexts/consolidate` - å‹ç¼©å†—ä½™æ¡ä»¶
- `GET /v1/persistent-contexts/stats` - è·å–ç»Ÿè®¡ä¿¡æ¯
- `POST /v1/persistent-contexts/{context_id}/used` - æ ‡è®°å·²ä½¿ç”¨

---

### â­ 2. é…ç½®çƒ­æ›´æ–°ç³»ç»Ÿ

**å®ç°ä½ç½®**ï¼š`recall/server.py`

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **æ— éœ€é‡å¯æ›´æ–°é…ç½®** | ä¿®æ”¹ `api_keys.env` åè°ƒç”¨ reload å³å¯ç”Ÿæ•ˆ |
| **API è¿æ¥æµ‹è¯•** | ä¸€é”®æµ‹è¯• Embedding/LLM API æ˜¯å¦å¯ç”¨ |
| **è‡ªåŠ¨ç»´åº¦æ£€æµ‹** | è‡ªåŠ¨æ£€æµ‹ Embedding æ¨¡å‹çš„å‘é‡ç»´åº¦ |
| **æ¨¡å‹åˆ—è¡¨è·å–** | è·å– API å¯ç”¨çš„æ¨¡å‹åˆ—è¡¨ |

**API ç«¯ç‚¹**ï¼š
- `POST /v1/config/reload` - é‡æ–°åŠ è½½é…ç½®
- `GET /v1/config/test` - æµ‹è¯• Embedding è¿æ¥
- `GET /v1/config/test/llm` - æµ‹è¯• LLM è¿æ¥
- `GET /v1/config/models` - è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨

---

### â­ 3. ä¼ç¬”åˆ†æå™¨å¢å¼º

**å®ç°ä½ç½®**ï¼š`recall/processor/foreshadowing_analyzer.py`

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **LLM è‡ªåŠ¨æ£€æµ‹** | ä½¿ç”¨ LLM è‡ªåŠ¨è¯†åˆ«å¯¹è¯ä¸­çš„ä¼ç¬” |
| **æ‰‹åŠ¨/è‡ªåŠ¨æ¨¡å¼åˆ‡æ¢** | æ”¯æŒåœ¨è¿è¡Œæ—¶åˆ‡æ¢åˆ†ææ¨¡å¼ |
| **å¯é…ç½®è§¦å‘é—´éš”** | æ¯ N è½®å¯¹è¯è§¦å‘ä¸€æ¬¡è‡ªåŠ¨åˆ†æ |
| **ä¸»åŠ¨æé†’** | åœ¨ build_context ä¸­æ³¨å…¥æ´»è·ƒä¼ç¬”ï¼Œæé†’ AI æ¨è¿› |

**API ç«¯ç‚¹**ï¼š
- `GET /v1/foreshadowing/analyzer/config` - è·å–åˆ†æå™¨é…ç½®
- `PUT /v1/foreshadowing/analyzer/config` - æ›´æ–°åˆ†æå™¨é…ç½®
- `POST /v1/foreshadowing/analyze/turn` - åˆ†æå•è½®å¯¹è¯
- `POST /v1/foreshadowing/analyze/trigger` - æ‰‹åŠ¨è§¦å‘åˆ†æ

---

### â­ 4. è¯­ä¹‰å»é‡ç³»ç»Ÿï¼ˆ2026-01-19 æ–°å¢ï¼‰

**å®ç°ä½ç½®**ï¼š`recall/processor/context_tracker.py`ã€`recall/processor/foreshadowing.py`

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **ä¸‰çº§å»é‡ç­–ç•¥** | Embeddingä½™å¼¦ç›¸ä¼¼åº¦ â†’ ç²¾ç¡®åŒ¹é… â†’ è¯é‡å åå¤‡ |
| **å¯é…ç½®é˜ˆå€¼** | é«˜é˜ˆå€¼(â‰¥0.85)è‡ªåŠ¨åˆå¹¶ï¼Œä½é˜ˆå€¼(<0.70)è§†ä¸ºä¸åŒ |
| **å‘åå…¼å®¹** | æ—§æ•°æ®æ— Embeddingæ—¶è‡ªåŠ¨é™çº§ä¸ºè¯é‡å æ–¹æ¡ˆ |
| **ç¯å¢ƒå˜é‡é…ç½®** | `DEDUP_EMBEDDING_ENABLED`ã€`DEDUP_HIGH_THRESHOLD`ã€`DEDUP_LOW_THRESHOLD` |

**é…ç½®é¡¹**ï¼ˆé€šè¿‡ `api_keys.env`ï¼‰ï¼š
```env
DEDUP_EMBEDDING_ENABLED=true   # æ˜¯å¦å¯ç”¨Embeddingå»é‡
DEDUP_HIGH_THRESHOLD=0.85      # é«˜ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆè‡ªåŠ¨åˆå¹¶ï¼‰
DEDUP_LOW_THRESHOLD=0.70       # ä½ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆè§†ä¸ºä¸åŒï¼‰
```

**æ”¯æŒçš„ç³»ç»Ÿ**ï¼š
- ContextTrackerï¼ˆæŒä¹…æ¡ä»¶ç³»ç»Ÿï¼‰
- ForeshadowingTrackerï¼ˆä¼ç¬”ç³»ç»Ÿï¼‰

---

## äºŒã€è¯¦ç»†å¯¹ç…§æ£€æŸ¥

### ç¬¬ä¸€ç»„ï¼šæ ¸å¿ƒåŠŸèƒ½éœ€æ±‚ï¼ˆ15é¡¹ï¼‰

| # | éœ€æ±‚ | è®¡åˆ’æ–¹æ¡ˆ | å®é™…çŠ¶æ€ | å®ç°ä½ç½® |
|---|------|---------|:--------:|---------|
| 1 | ä¸Šä¸‡è½® RP | åˆ†å·å­˜å‚¨ + O(1)å®šä½ + é¢„åŠ è½½ + å¹¶å‘é” | âœ… | `recall/storage/volume_manager.py` |
| 2 | ä¼ç¬”ä¸é—å¿˜ | ~~ä¸‰é‡æ£€æµ‹~~ â†’ **LLM API æ–°æ–¹æ¡ˆ** | âœ… | `recall/processor/foreshadowing_analyzer.py` |
| 3 | å‡ ç™¾ä¸‡å­—è§„æ¨¡ | åˆ†å·æ¶æ„ + æ‡’åŠ è½½ + å¢é‡ç´¢å¼• | âœ… | `VolumeManager` æ¯å·50MB |
| 4 | ä¸Šåƒæ–‡ä»¶ä»£ç  | å¤šè¯­è¨€è§£æå™¨ + ç¬¦å·è¡¨ + ä¾èµ–å›¾ | âŒ | æœªå®ç°ï¼ˆä»£ç åœºæ™¯ï¼ŒRPå¯é€‰ï¼‰ |
| 5 | è§„èŒƒ100%éµå®ˆ | L0æ³¨å…¥ + è§„åˆ™ç¼–è¯‘ + å±æ€§æ£€æŸ¥ | âœ… | L0æ³¨å…¥âœ… å±æ€§æ£€æµ‹âœ… ç»å¯¹è§„åˆ™æ£€æµ‹âœ…ï¼ˆ2026-01-24å®Œæˆï¼‰ |
| 6 | é›¶é…ç½®å³æ’å³ç”¨ | pip install + API key å³å¯ä½¿ç”¨ | âœ… | `pyproject.toml` |
| 7 | 100%ä¸é—å¿˜ | ArchiveåŸæ–‡ä¿å­˜ + 8å±‚æ£€ç´¢ + N-gramå…œåº• | âœ… | `recall/retrieval/eight_layer.py` |
| 8 | é¢å‘å¤§ä¼—å‹å¥½ | STæ’ä»¶å¸‚åœºå®‰è£… + 3æ­¥å®Œæˆ + å…¨ä¸­æ–‡ | âœ… | `plugins/sillytavern/` |
| 9 | é…ç½®keyå°±èƒ½ç”¨ | åªéœ€è®¾ç½®ä¸€ä¸ª API key ç¯å¢ƒå˜é‡ | âœ… | `api_keys.env` |
| 10 | pip installå³æ’å³ç”¨ | å‘½ä»¤è¡Œä¸¤æ­¥å®Œæˆ | âœ… | CLIå®Œæ•´æ”¯æŒ |
| 11 | æ™®é€šäººæ— é—¨æ§› | çº¯æœ¬åœ°æ’ä»¶ + ç”¨æˆ·è‡ªå·±çš„API key | âœ… | ç‹¬ç«‹è¿è¡Œ |
| 12 | 3-5ç§’å“åº” | å¹¶è¡Œæ£€ç´¢ + å¼‚æ­¥å†™å…¥ + ç¼“å­˜çƒ­è·¯å¾„ | âœ… | `recall/retrieval/parallel_retrieval.py` |
| 13 | çŸ¥è¯†å›¾è°± | è½»é‡çº§æœ¬åœ°å›¾ç»“æ„ + å…³ç³»è‡ªåŠ¨æå– | âœ… | `recall/graph/knowledge_graph.py` |
| 14 | å¤šç”¨æˆ·/å¤šè§’è‰² | MemoryScope ä½œç”¨åŸŸéš”ç¦» | âœ… | `recall/storage/multi_tenant.py` |
| 15 | ä½é…ç”µè„‘æ”¯æŒ | Lite æ¨¡å¼ï¼ˆ~80MBå†…å­˜ï¼‰+ æ— GPUè¦æ±‚ | âœ… | `--lite` æ¨¡å¼ (--lightweight ä¸ºåˆ«å) |

### ç¬¬äºŒç»„ï¼šå³æ’å³ç”¨/ç¯å¢ƒéš”ç¦»æ£€æŸ¥é¡¹ï¼ˆ10é¡¹ï¼‰

| # | éœ€æ±‚ | è®¡åˆ’æ–¹æ¡ˆ | å®é™…çŠ¶æ€ | å®ç°ä½ç½® |
|---|------|---------|:--------:|---------|
| 16 | å•ä¸€æ•°æ®ç›®å½• | æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ `./recall_data/` | âœ… | `RecallInit.get_data_root()` |
| 17 | æ¨¡å‹éš”ç¦»å­˜å‚¨ | NLPæ¨¡å‹ä¸‹è½½åˆ° `./recall_data/models/` | âœ… | `RecallInit.setup_environment()` |
| 18 | æ— ç³»ç»Ÿçº§ä¿®æ”¹ | ä¸ä¿®æ”¹æ³¨å†Œè¡¨/ç³»ç»ŸæœåŠ¡/PATH | âœ… | æ— ç³»ç»Ÿçº§æ“ä½œ |
| 19 | ç¯å¢ƒå˜é‡éš”ç¦» | è¿è¡Œæ—¶ä¸´æ—¶è®¾ç½®ï¼Œé€€å‡ºæ—¶æ¢å¤ | âœ… | `recall/init.py` |
| 20 | å®Œæ•´å¸è½½æ”¯æŒ | pip uninstall + åˆ é™¤ç›®å½• = å®Œå…¨å¹²å‡€ | âœ… | åˆ é™¤æ–‡ä»¶å¤¹å³å¯ |
| 21 | è™šæ‹Ÿç¯å¢ƒå…¼å®¹ | æ”¯æŒåœ¨ venv ä¸­å®‰è£… | âœ… | `recall-env` |
| 22 | ä¸ä¿®æ”¹å…¶ä»–åº”ç”¨ | ST æ’ä»¶ç‹¬ç«‹ï¼Œä¸ä¿®æ”¹ ST åŸé…ç½® | âœ… | IIFEéš”ç¦» |
| 23 | ç¦»çº¿è¿è¡Œæ”¯æŒ | æ¨¡å‹ä¸‹è½½åå¯ç¦»çº¿è¿è¡Œ | âœ… | æœ¬åœ°spaCy/å‘é‡æ¨¡å‹ |
| 24 | è·¨å¹³å°æ”¯æŒ | Windows/Mac/Linux ç»Ÿä¸€è¡Œä¸º | âœ… | å¤šå¹³å°è„šæœ¬ |
| 25 | é…ç½®æ–‡ä»¶éš”ç¦» | é…ç½®å­˜å‚¨åœ¨ `./recall_data/config.json` | âœ… | é¡¹ç›®ç›®å½•å†… |

### ç¬¬ä¸‰ç»„ï¼šè®¡åˆ’å¤–æ–°å¢åŠŸèƒ½ï¼ˆ3é¡¹ï¼‰â­

> ğŸ“Œ ä»¥ä¸‹åŠŸèƒ½**è¶…å‡ºåŸè®¡åˆ’éœ€æ±‚**ï¼Œæ˜¯å¼€å‘è¿‡ç¨‹ä¸­æ–°å¢çš„å¢å¼ºåŠŸèƒ½ã€‚

| # | åŠŸèƒ½ | å®ç°æ–¹æ¡ˆ | å®é™…çŠ¶æ€ | å®ç°ä½ç½® |
|---|------|---------|:--------:|---------|
| 26 | â­ æŒä¹…æ¡ä»¶ç³»ç»Ÿ | ContextTracker + 15ç§æ¡ä»¶ç±»å‹ + è‡ªåŠ¨æå– | âœ… | `recall/processor/context_tracker.py` |
| 27 | â­ é…ç½®çƒ­æ›´æ–° | reload API + è¿æ¥æµ‹è¯• + ç»´åº¦æ£€æµ‹ | âœ… | `recall/server.py` |
| 28 | â­ ä¼ç¬”åˆ†æå™¨å¢å¼º | LLMæ¨¡å¼ + get_context_for_prompt | âœ… | `recall/processor/foreshadowing_analyzer.py` |

---

## ä¸‰ã€åŠŸèƒ½å·®å¼‚è¯¦ç»†è¯´æ˜

### âœ… 1. ä¼ç¬”è‡ªåŠ¨æ£€æµ‹ - LLM æ–°æ–¹æ¡ˆå·²å®ç°

**åŸè®¡åˆ’**ï¼šä¸‰é‡æ£€æµ‹ï¼ˆå…³é”®è¯+ç»„åˆ+è¯­ä¹‰ï¼‰+ ä¸»åŠ¨æé†’

**æ–°æ–¹æ¡ˆ**ï¼šLLM API æ™ºèƒ½åˆ†æï¼ˆæ›´ä¼˜ï¼‰âœ… **å·²å®ç°ï¼ˆ2026-01-18ï¼‰**

| å¯¹æ¯” | åŸè®¡åˆ’ï¼ˆè§„åˆ™åŒ¹é…ï¼‰ | æ–°æ–¹æ¡ˆï¼ˆLLM APIï¼‰ |
|------|:----------------:|:-----------------:|
| å‡†ç¡®æ€§ | â­â­ | â­â­â­â­â­ |
| éšå«ä¼ç¬”è¯†åˆ« | âŒ | âœ… |
| ç»´æŠ¤æˆæœ¬ | é«˜ï¼ˆéœ€ç»´æŠ¤è¯åº“ï¼‰ | ä½ |
| è¿è¡Œæˆæœ¬ | å…è´¹ | æä½ï¼ˆ~$0.01/100è½®ï¼‰ |

**å®ç°ä½ç½®**ï¼š`recall/processor/foreshadowing_analyzer.py`

**API ç«¯ç‚¹**ï¼š
- `POST /v1/foreshadowing/analyze/turn` - æ¯è½®å¯¹è¯åˆ†æ
- `POST /v1/foreshadowing/analyze/trigger` - æ‰‹åŠ¨è§¦å‘åˆ†æ
- `GET /v1/foreshadowing/analyzer/config` - è·å–åˆ†æå™¨é…ç½®
- `PUT /v1/foreshadowing/analyzer/config` - æ›´æ–°åˆ†æå™¨é…ç½®

---

### âŒ 2. CodeIndexerï¼ˆä»£ç ç´¢å¼•å™¨ï¼‰- æœªå®ç°ï¼ˆå¯é€‰ï¼‰

**è®¡åˆ’æ–‡æ¡£ä½ç½®**ï¼šç¬¬äº”èŠ‚ CodeIndexer

**è®¡åˆ’è¦æ±‚**ï¼š
```python
class CodeIndexer:
    """ä»£ç ç´¢å¼•å™¨"""
    def index_file(self, file_path: str) -> None: ...
    def index_directory(self, dir_path: str) -> None: ...
    def search_symbol(self, name: str) -> List[Symbol]: ...
    def get_dependencies(self, file_path: str) -> List[str]: ...
```

**åº”åŒ…å«åŠŸèƒ½**ï¼š
- å¤šè¯­è¨€è§£æå™¨ï¼ˆPython/JS/Java/Go/Rustç­‰ï¼‰
- ç¬¦å·è¡¨ï¼ˆå‡½æ•°/ç±»/å˜é‡/å¸¸é‡ç´¢å¼•ï¼‰
- ä¾èµ–å›¾ï¼ˆimport/require/include åˆ†æï¼‰
- ä»£ç æœç´¢ï¼ˆæŒ‰ç¬¦å·åã€æŒ‰æ–‡ä»¶è·¯å¾„ï¼‰

**å½“å‰çŠ¶æ€**ï¼šé¡¹ç›®ä¸­ä¸å­˜åœ¨ `code_indexer.py` æ–‡ä»¶

**å»ºè®®**ï¼šæ­¤åŠŸèƒ½é¢å‘"ä»£ç åœºæ™¯"ï¼Œå¦‚æœé¡¹ç›®ä¸»è¦é¢å‘ RP/å°è¯´åœºæ™¯ï¼š
- æ–¹æ¡ˆAï¼šæ ‡è®°ä¸º v3.1 ç‰ˆæœ¬åŠŸèƒ½
- æ–¹æ¡ˆBï¼šä»éœ€æ±‚åˆ—è¡¨ä¸­ç§»é™¤

---

### âœ… 3. è§„èŒƒ100%éµå®ˆ - âœ… å·²å®Œæˆï¼ˆ2026-01-24 LLMè¯­ä¹‰æ£€æµ‹ï¼‰

**è®¡åˆ’è¦æ±‚**ï¼šL0æ³¨å…¥ + è§„åˆ™ç¼–è¯‘ + å±æ€§æ£€æŸ¥

**å®é™…çŠ¶æ€**ï¼š

| å­åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|--------|:----:|------|
| L0æ ¸å¿ƒè®¾å®šæ³¨å…¥ | âœ… | `layer0_core.py` - è§’è‰²å¡ã€ä¸–ç•Œè§‚ã€å†™ä½œé£æ ¼ |
| `absolute_rules` å­˜å‚¨ | âœ… | ç”¨æˆ·å¯é…ç½®çš„ç»å¯¹è§„åˆ™åˆ—è¡¨ |
| `get_injection_text()` | âœ… | æŒ‰åœºæ™¯(RP/coding)è¿”å›æ³¨å…¥å†…å®¹ |
| **â­æ•°å€¼å±æ€§å†²çªæ£€æµ‹** | âœ… | å¹´é¾„/èº«é«˜/ä½“é‡ç­‰ï¼ˆ2026-01-24å¢å¼ºï¼‰ |
| **â­å¤–è²Œå±æ€§å†²çªæ£€æµ‹** | âœ… | å‘è‰²/çœ¼è‰²/è‚¤è‰²ï¼Œæ”¯æŒé¢œè‰²åŒä¹‰è¯åˆå¹¶ |
| **â­çŠ¶æ€å†²çªæ£€æµ‹** | âœ… | ç”Ÿæ­»/å©šå§»çŠ¶æ€ï¼Œè‡ªåŠ¨æ£€æµ‹å¯¹ç«‹çŠ¶æ€ |
| **â­å…³ç³»å†²çªæ£€æµ‹** | âœ… | æœ‹å‹vsæ•Œäººç­‰å¯¹ç«‹å…³ç³»æ£€æµ‹ |
| **â­æ—¶é—´çº¿å®Œæ•´æ£€æµ‹** | âœ… | å¹´é¾„ä¸€è‡´æ€§ã€äº‹ä»¶é¡ºåºã€æ—¶æ€å†²çª |
| **â­å¦å®šå¥è¿åæ£€æµ‹** | âœ… | "ä¸ä¼šX"ä½†åšäº†Xçš„é€»è¾‘é”™è¯¯æ£€æµ‹ |
| **â­ç”Ÿæ­»çŸ›ç›¾æ£€æµ‹** | âœ… | è§’è‰²æ­»åè¡ŒåŠ¨çš„é€»è¾‘é”™è¯¯æ£€æµ‹ |
| **â­ ç»å¯¹è§„åˆ™LLMæ£€æµ‹** | âœ… | **LLMè¯­ä¹‰ç†è§£ï¼Œæ”¯æŒä»»æ„å¤æ‚è§„åˆ™ï¼**ï¼ˆ2026-01-24å®ç°ï¼‰ |
| è­¦å‘Šå†å²è®°å½• | ï¿½ å¯é€‰ | å¼¹çª—æ¶ˆå¤±åæ— æ³•æŸ¥çœ‹å†å²è­¦å‘Šï¼ˆéæ ¸å¿ƒåŠŸèƒ½ï¼‰ |

---

#### âœ… ç»å¯¹è§„åˆ™æ£€æµ‹å·²å®ç°ï¼ˆ2026-01-24 - LLMè¯­ä¹‰ç‰ˆï¼‰

**æ ¸å¿ƒæ”¹è¿›**ï¼šä½¿ç”¨ **LLM è¿›è¡Œè¯­ä¹‰ç†è§£**ï¼Œä¸å†æ˜¯ç®€å•çš„å…³é”®è¯åŒ¹é…ï¼

**æ”¯æŒçš„è§„åˆ™æ ¼å¼**ï¼š
- âœ… **ä»»æ„é•¿åº¦çš„è‡ªç„¶è¯­è¨€æè¿°**
- âœ… ã€Œè§’è‰²æ˜¯ä¸€ä¸ªæ¸©æŸ”çš„å¥³å­©ï¼Œå¥¹ä»ä¸ä¼šå¯¹ä»»ä½•äººå‘ç«ï¼Œå³ä½¿è¢«æ¬ºè´Ÿä¹Ÿä¼šé€‰æ‹©å¿è€ã€
- âœ… ã€Œè§’è‰²è¯´è¯æ—¶æ€»æ˜¯ç”¨æ•¬è¯­ï¼Œä»ä¸ç›´å‘¼å¯¹æ–¹åå­—ã€
- âœ… ã€Œç¦æ­¢å‡ºç°ä»»ä½•å½¢å¼çš„æš´åŠ›æå†™ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºæ‰“æ–—ã€ä¼¤å®³ã€å¨èƒã€
- âœ… è¯­ä¹‰ç­‰ä»·ç†è§£ï¼ˆ"å‘ç«"="ç”Ÿæ°”"="æ„¤æ€’"ï¼‰
- âœ… éšå«è¿åæ£€æµ‹ï¼ˆè§„åˆ™æ˜¯"æ¸©æŸ”"ï¼Œ"ç‹ ç‹ åœ°è¸¢"å°±æ˜¯è¿åï¼‰

**å·¥ä½œé“¾è·¯**ï¼š
```
ç”¨æˆ·æ·»åŠ è§„åˆ™ï¼ˆå¯ä»¥æ˜¯ä¸€é•¿æ®µæè¿°ï¼‰
         â†“
å­˜å‚¨åˆ° CoreSettings.absolute_rules 
         â†“
APIæ›´æ–°æ—¶åŒæ­¥åˆ° ConsistencyChecker
         â†“
æ–°æ¶ˆæ¯åˆ°è¾¾ â†’ check() â†’ _check_rules_with_llm()
         â†“
LLM åˆ†æå†…å®¹æ˜¯å¦è¿åä»»ä½•è§„åˆ™ï¼ˆè¯­ä¹‰ç†è§£ï¼‰
         â†“
æ£€æµ‹åˆ°è¿è§„ â†’ è¿”å›è¯¦ç»†è¯´æ˜ â†’ å‰ç«¯ toastr å¼¹çª—
```

**æŠ€æœ¯å®ç°**ï¼š
- `ConsistencyChecker` æ¥æ”¶ `llm_client` å‚æ•°
- `_check_rules_with_llm()` æ„å»ºæ£€æµ‹ promptï¼Œè®© LLM åˆ¤æ–­
- æ—  LLM æ—¶åŠŸèƒ½ä¸ç”Ÿæ•ˆï¼ˆè§„åˆ™æ£€æµ‹éœ€è¦è¯­ä¹‰ç†è§£ï¼Œå…³é”®è¯åŒ¹é…ä¼šäº§ç”Ÿè¯¯æŠ¥ï¼‰
- æ¯æ¬¡æ£€æµ‹çº¦æ¶ˆè€— ~500 tokensï¼ˆæˆæœ¬æä½ï¼‰

**å¢å¼ºç‰ˆ ConsistencyChecker åŠŸèƒ½æ¸…å•**ï¼ˆ2026-01-24ï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ConsistencyChecker v4.0 (LLMè¯­ä¹‰ç‰ˆ)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å±æ€§æ£€æµ‹ï¼ˆ15+ç§ï¼‰:                                          â”‚
â”‚  â”œâ”€ æ•°å€¼å±æ€§: å¹´é¾„ã€èº«é«˜ã€ä½“é‡                               â”‚
â”‚  â”œâ”€ å¤–è²Œå±æ€§: å‘è‰²ã€çœ¼è‰²ã€è‚¤è‰²ï¼ˆæ”¯æŒé¢œè‰²åŒä¹‰è¯åˆå¹¶ï¼‰         â”‚
â”‚  â”œâ”€ å›ºå®šå±æ€§: è¡€å‹ã€æ€§åˆ«ã€ç§æ—                               â”‚
â”‚  â””â”€ çŠ¶æ€å±æ€§: ç”Ÿæ­»çŠ¶æ€ã€å©šå§»çŠ¶æ€ã€èŒä¸šã€ä½ç½®                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å…³ç³»æ£€æµ‹:                                                   â”‚
â”‚  â”œâ”€ å¯¹ç«‹å…³ç³»è¯å…¸: æœ‹å‹â†”æ•Œäºº, æ‹äººâ†”ä»‡äºº, ä¿¡ä»»â†”èƒŒå›           â”‚
â”‚  â””â”€ åŒå‘å…³ç³»å­˜å‚¨: Aå’ŒBçš„å…³ç³» = Bå’ŒAçš„å…³ç³»                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ—¶é—´çº¿æ£€æµ‹ï¼ˆå®Œæ•´ç‰ˆï¼‰:                                       â”‚
â”‚  â”œâ”€ æ—¶æ€å†²çª: åŒä¸€æ—¥æœŸçš„è¿‡å»/å°†æ¥æè¿°çŸ›ç›¾                   â”‚
â”‚  â”œâ”€ å¹´é¾„ä¸€è‡´æ€§: "Nå¹´å‰Xå²" â†’ ç°åœ¨åº”è¯¥æ˜¯X+Nå²               â”‚
â”‚  â”œâ”€ äº‹ä»¶é¡ºåº: "Aåœ¨Bä¹‹å‰" vs "Båœ¨Aä¹‹å‰"                      â”‚
â”‚  â””â”€ ç”Ÿæ­»çŸ›ç›¾: è§’è‰²æ­»äº¡åä¸èƒ½æœ‰æ–°åŠ¨ä½œ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¦å®šå¥æ£€æµ‹:                                                 â”‚
â”‚  â”œâ”€ æ¨¡å¼: ä¸ä¼š/ä¸èƒ½/æ— æ³•/ä»ä¸/ç»ä¸                          â”‚
â”‚  â””â”€ è¿å: å£°ç§°"ä¸ä¼šX"ä½†åæ¥"åšäº†X"                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â­ ç»å¯¹è§„åˆ™LLMæ£€æµ‹ï¼ˆ2026-01-24æ–°å¢ï¼‰:                       â”‚
â”‚  â”œâ”€ LLMè¯­ä¹‰ç†è§£: æ”¯æŒä»»æ„é•¿åº¦çš„è‡ªç„¶è¯­è¨€è§„åˆ™æè¿°              â”‚
â”‚  â”œâ”€ è¯­ä¹‰ç­‰ä»·: "å‘ç«"="ç”Ÿæ°”"="æ„¤æ€’" è‡ªåŠ¨ç†è§£                 â”‚
â”‚  â”œâ”€ éšå«è¿å: è§„åˆ™"æ¸©æŸ”" â†’ æ£€æµ‹"ç‹ ç‹ åœ°è¸¢"                  â”‚
â”‚  â””â”€ ä¾èµ–LLM: æ— LLMæ—¶åŠŸèƒ½ä¸ç”Ÿæ•ˆï¼ˆéœ€é…ç½®LLM_API_KEYï¼‰         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é¢œè‰²åŒä¹‰è¯åˆå¹¶:                                             â”‚
â”‚  â”œâ”€ black: é»‘è‰²/ä¹Œé»‘/æ¼†é»‘/å¢¨é»‘                              â”‚
â”‚  â”œâ”€ blonde: é‡‘è‰²/é‡‘é»„/æ·¡é‡‘/äºšéº»è‰²                           â”‚
â”‚  â””â”€ ... (11ç§åŸºç¡€é¢œè‰²çš„åŒä¹‰è¯åº“)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯¹ RP åœºæ™¯çš„å½±å“**ï¼š
- âœ… å®Œæ•´çš„å±æ€§å†²çªæ£€æµ‹ï¼Œé¿å…"é»‘å‘"çªç„¶å˜"é‡‘å‘"
- âœ… å…³ç³»ä¸€è‡´æ€§æ£€æŸ¥ï¼Œé¿å…"æœ‹å‹"çªç„¶å˜"æ•Œäºº"
- âœ… ç”Ÿæ­»çŸ›ç›¾æ£€æµ‹ï¼Œé¿å…"æ­»æ‰çš„è§’è‰²ç»§ç»­è¡ŒåŠ¨"
- âœ… å¹´é¾„æ—¶é—´çº¿æ£€æŸ¥ï¼Œç¡®ä¿å¹´é¾„å˜åŒ–ç¬¦åˆæ—¶é—´æµé€
- âœ… **ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ LLM è¯­ä¹‰æ£€æµ‹**ï¼Œæ”¯æŒä»»æ„å¤æ‚çš„è§„åˆ™æè¿°ï¼

---

### âœ… 4. ä¼ç¬”åŸºç¡€åŠŸèƒ½ - å·²å®Œæˆ

ä»¥ä¸‹åŠŸèƒ½å·²åœ¨ `recall/processor/foreshadowing.py` ä¸­å®ç°ï¼š

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|:----:|------|
| `plant()` | âœ… | æ‰‹åŠ¨åŸ‹ä¸‹ä¼ç¬”ï¼ˆæ”¯æŒè¯­ä¹‰å»é‡ï¼‰ |
| `add_hint()` | âœ… | æ·»åŠ ä¼ç¬”æç¤º |
| `resolve()` | âœ… | æ‰‹åŠ¨è§£å†³ä¼ç¬” |
| `abandon()` | âœ… | æ”¾å¼ƒä¼ç¬” |
| `get_active()` | âœ… | è·å–æ´»è·ƒä¼ç¬” |
| `get_by_entity()` | âœ… | æŒ‰å®ä½“è·å–ä¼ç¬” |
| å¤šè§’è‰²åˆ†éš”å­˜å‚¨ | âœ… | æ¯ä¸ªè§’è‰²ç‹¬ç«‹å­˜å‚¨ |
| **â­ è¯­ä¹‰å»é‡** | âœ… | Embeddingä½™å¼¦ç›¸ä¼¼åº¦ï¼Œé˜²æ­¢é‡å¤ä¼ç¬”ï¼ˆ2026-01-19æ–°å¢ï¼‰ |

> ğŸ’¡ æ–°å¢çš„ `ForeshadowingAnalyzer` å°†åŸºäºè¿™äº›å·²æœ‰åŠŸèƒ½æ„å»ºã€‚

---

### ğŸ“ 4. æ–‡ä»¶ç»“æ„å·®å¼‚ï¼ˆéåŠŸèƒ½ç¼ºå¤±ï¼‰

**è®¡åˆ’æ–‡æ¡£è¦æ±‚çš„æ–‡ä»¶ç»“æ„**ï¼š
```
recall/storage/
â”œâ”€â”€ layer0_core.py       âœ… å·²æœ‰
â”œâ”€â”€ layer1_consolidated.py âœ… å·²æœ‰
â”œâ”€â”€ layer2_working.py    âœ… å·²æœ‰
â”œâ”€â”€ layer3_archive.py    âšª åˆå¹¶åˆ° volume_manager.py
â”œâ”€â”€ volume_manager.py    âœ… å·²æœ‰
â””â”€â”€ multi_tenant.py      âœ… å·²æœ‰
```

**è¯´æ˜**ï¼šL3åŸæ–‡å­˜æ¡£åŠŸèƒ½å·²åœ¨ `volume_manager.py` ä¸­å®ç°ã€‚è¿™æ˜¯æ¶æ„ç®€åŒ–ï¼Œ**ä¸å½±å“åŠŸèƒ½å®Œæ•´æ€§**ã€‚

---

## å››ã€ç¼ºå¤±åŠŸèƒ½å®ç°è®¡åˆ’

### é˜¶æ®µä¸€ï¼šä¼ç¬”è‡ªåŠ¨æ£€æµ‹ï¼ˆä¼˜å…ˆçº§ï¼šğŸ”´ é«˜ï¼‰- LLM æ–¹æ¡ˆ

**é¢„è®¡å·¥ä½œé‡**ï¼š2-3å¤©

> ğŸ’¡ **è®¾è®¡ç†å¿µ**ï¼šç®€æ´çš„åŒæ¨¡å¼è®¾è®¡ã€‚æ—  API æ—¶æ‰‹åŠ¨ç®¡ç†ï¼Œæœ‰ API æ—¶æ™ºèƒ½åˆ†æã€‚æ‰¹é‡å¤„ç†é™ä½ LLM æˆæœ¬ã€‚

---

#### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ForeshadowingAnalyzer                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åç«¯æ¨¡å¼ï¼ˆä¸¤ç§æ¨¡å¼ï¼Œæ‰‹åŠ¨æ“ä½œå§‹ç»ˆå¯ç”¨ï¼‰:                      â”‚
â”‚  â”œâ”€ MANUAL (é»˜è®¤) - çº¯æ‰‹åŠ¨ï¼Œç”¨æˆ·è‡ªå·±ç®¡ç†ä¼ç¬”                 â”‚
â”‚  â””â”€ LLM - æ‰‹åŠ¨ + è‡ªåŠ¨è¾…åŠ©æ£€æµ‹ï¼ˆéœ€é…ç½®API keyï¼‰               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš ï¸ é‡è¦ï¼šæ— è®ºå“ªç§æ¨¡å¼ï¼Œæ‰‹åŠ¨ API å§‹ç»ˆå¯ç”¨ï¼                  â”‚
â”‚  â”œâ”€ plant() - æ‰‹åŠ¨åŸ‹ä¼ç¬”                                     â”‚
â”‚  â”œâ”€ resolve() - æ‰‹åŠ¨æ ‡è®°è§£å†³                                 â”‚
â”‚  â”œâ”€ get_active() - æŸ¥çœ‹æ´»è·ƒä¼ç¬”                              â”‚
â”‚  â””â”€ LLM æ¨¡å¼åªæ˜¯é¢å¤–å¢åŠ ã€Œè‡ªåŠ¨æ£€æµ‹å»ºè®®ã€åŠŸèƒ½                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é…ç½®é¡¹ï¼ˆLLMæ¨¡å¼é¢å¤–åŠŸèƒ½ï¼‰:                                   â”‚
â”‚  â”œâ”€ trigger_interval: æ¯Nè½®è§¦å‘ä¸€æ¬¡ (é»˜è®¤10è½®)               â”‚
â”‚  â”œâ”€ llm_model: ä½¿ç”¨çš„æ¨¡å‹ (é»˜è®¤ gpt-4o-mini)                 â”‚
â”‚  â”œâ”€ auto_plant: è‡ªåŠ¨åŸ‹ä¸‹æ£€æµ‹åˆ°çš„ä¼ç¬” (é»˜è®¤ true)             â”‚
â”‚  â””â”€ auto_resolve: è‡ªåŠ¨æ ‡è®°è§£å†³ (é»˜è®¤ falseï¼Œå»ºè®®æ‰‹åŠ¨ç¡®è®¤)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å·¥ä½œæµç¨‹ï¼ˆLLMæ¨¡å¼ï¼‰:                                        â”‚
â”‚  1. ç´¯ç§¯å¯¹è¯å†…å®¹åˆ°ç¼“å†²åŒº                                     â”‚
â”‚  2. è¾¾åˆ°è§¦å‘æ¡ä»¶æ—¶ï¼Œæ‰¹é‡å‘é€ç»™ LLM åˆ†æ                      â”‚
â”‚  3. è§£æ LLM è¿”å›çš„ JSON ç»“æœ                                â”‚
â”‚  4. auto_plant=true è‡ªåŠ¨æ·»åŠ ï¼Œå¦åˆ™åªæç¤ºç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ’¡ **è®¾è®¡ç†å¿µ**ï¼šLLM æ˜¯è¾…åŠ©ï¼Œä¸æ˜¯æ›¿ä»£ã€‚ç”¨æˆ·éšæ—¶å¯ä»¥æ‰‹åŠ¨æ·»åŠ /ç¼–è¾‘/åˆ é™¤ä¼ç¬”ã€‚
> 
> ğŸ’¡ **ä¸ºä»€ä¹ˆä¸åšè§„åˆ™åŒ¹é…ï¼Ÿ** è§„åˆ™ä¸å¯èƒ½å…¨é¢ï¼Œç¨å¾®å¤æ‚çš„ä¼ç¬”å°±æ£€æµ‹ä¸å‡ºæ¥ã€‚

---

#### ä»»åŠ¡ 1.1ï¼šåˆ›å»ºé…ç½®ç±»

**æ–‡ä»¶**ï¼š`recall/processor/foreshadowing_analyzer.py`

```python
from dataclasses import dataclass
from enum import Enum
from typing import Optional, List, Dict, Any

class AnalyzerBackend(Enum):
    """åˆ†æå™¨åç«¯ç±»å‹"""
    MANUAL = "manual"  # æ‰‹åŠ¨æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
    LLM = "llm"        # LLM æ™ºèƒ½åˆ†æï¼ˆéœ€é…ç½® APIï¼‰

@dataclass
class ForeshadowingAnalyzerConfig:
    """ä¼ç¬”åˆ†æå™¨é…ç½®"""
    # åç«¯é€‰æ‹©ï¼ˆé»˜è®¤ MANUAL = æ‰‹åŠ¨æ¨¡å¼ï¼Œéœ€é…ç½® API æ‰èƒ½å¯ç”¨ LLM åˆ†æï¼‰
    backend: AnalyzerBackend = AnalyzerBackend.MANUAL
    
    # è§¦å‘æ¡ä»¶ï¼ˆLLM æ¨¡å¼ï¼‰
    trigger_interval: int = 10      # æ¯Nè½®è§¦å‘ä¸€æ¬¡åˆ†æï¼ˆæœ€å°1=æ¯è½®éƒ½è§¦å‘ï¼‰
    
    # LLM é…ç½®
    llm_model: str = "gpt-4o-mini"  # é»˜è®¤ç”¨ä¾¿å®œçš„æ¨¡å‹
    llm_api_key: Optional[str] = None
    llm_base_url: Optional[str] = None  # æ”¯æŒè‡ªå®šä¹‰ API åœ°å€
    
    # è¡Œä¸ºé…ç½®
    auto_plant: bool = True         # è‡ªåŠ¨åŸ‹ä¸‹æ£€æµ‹åˆ°çš„ä¼ç¬”
    auto_resolve: bool = False      # è‡ªåŠ¨æ ‡è®°è§£å†³ï¼ˆå»ºè®® Falseï¼Œè®©ç”¨æˆ·ç¡®è®¤ï¼‰
    include_resolved_check: bool = True  # åŒæ—¶æ£€æŸ¥å·²æœ‰ä¼ç¬”æ˜¯å¦è¢«è§£å†³
    
    # é«˜çº§é…ç½®
    max_context_turns: int = 20     # å‘é€ç»™ LLM çš„æœ€å¤§è½®æ¬¡æ•°
    language: str = "zh"            # æç¤ºè¯è¯­è¨€
    
    @classmethod
    def manual(cls) -> 'ForeshadowingAnalyzerConfig':
        """æ‰‹åŠ¨æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰- ç”¨æˆ·è‡ªå·±ç®¡ç†ä¼ç¬”"""
        return cls(backend=AnalyzerBackend.MANUAL)
    
    @classmethod
    def llm_based(
        cls, 
        api_key: str, 
        model: str = "gpt-4o-mini",
        trigger_interval: int = 10
    ) -> 'ForeshadowingAnalyzerConfig':
        """ä½¿ç”¨ LLM APIï¼ˆæ™ºèƒ½ï¼‰"""
        return cls(
            backend=AnalyzerBackend.LLM,
            llm_api_key=api_key,
            llm_model=model,
            trigger_interval=trigger_interval
        )
```

---

#### ä»»åŠ¡ 1.2ï¼šå®ç° LLM åˆ†æå™¨æ ¸å¿ƒ

```python
class ForeshadowingAnalyzer:
    """ä¼ç¬”åˆ†æå™¨ - æ‰‹åŠ¨æ¨¡å¼ / LLM æ™ºèƒ½åˆ†æ"""
    
    # LLM æç¤ºè¯æ¨¡æ¿
    ANALYSIS_PROMPT = '''ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å™äº‹åˆ†æå¸ˆã€‚è¯·åˆ†æä»¥ä¸‹å¯¹è¯å†…å®¹ï¼Œè¯†åˆ«å…¶ä¸­çš„ä¼ç¬”ï¼ˆforeshadowingï¼‰ã€‚

## ä»€ä¹ˆæ˜¯ä¼ç¬”ï¼Ÿ
ä¼ç¬”æ˜¯æ•…äº‹ä¸­åŸ‹ä¸‹çš„çº¿ç´¢ï¼Œæš—ç¤ºæœªæ¥ä¼šå‘ç”Ÿçš„äº‹æƒ…ï¼ŒåŒ…æ‹¬ï¼š
- ç¥ç§˜çš„æš—ç¤ºæˆ–é¢„è¨€
- æœªè§£é‡Šçš„äº‹ä»¶æˆ–ç°è±¡
- è§’è‰²æåˆ°çš„"æœ‰ä¸€å¤©ä¼š..."
- éšè—çš„ç§˜å¯†æˆ–è°œå›¢
- ä¸ç¥¥çš„å¾å…†

## å½“å‰æ´»è·ƒçš„ä¼ç¬”ï¼ˆå¦‚æœæœ‰ï¼‰ï¼š
{active_foreshadowings}

## æœ€è¿‘çš„å¯¹è¯å†…å®¹ï¼š
{conversation}

## è¯·è¾“å‡º JSON æ ¼å¼ï¼š
```json
{
  "new_foreshadowings": [
    {
      "content": "ä¼ç¬”å†…å®¹æè¿°",
      "importance": 0.8,  // 0-1ï¼Œé‡è¦æ€§
      "evidence": "åŸæ–‡ä¾æ®ï¼ˆå¼•ç”¨å¯¹è¯ä¸­çš„å¥å­ï¼‰",
      "related_entities": ["è§’è‰²A", "ç‰©å“B"]
    }
  ],
  "potentially_resolved": [
    {
      "foreshadowing_id": "fsh_xxx",
      "evidence": "è§£å†³çš„ä¾æ®",
      "confidence": 0.9  // ç½®ä¿¡åº¦
    }
  ],
  "analysis_notes": "ç®€è¦åˆ†æè¯´æ˜"
}
```

åªè¾“å‡º JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ä¼ç¬”ï¼Œè¿”å›ç©ºæ•°ç»„ã€‚'''

    def __init__(
        self, 
        config: ForeshadowingAnalyzerConfig,
        tracker: 'ForeshadowingTracker'
    ):
        self.config = config
        self.tracker = tracker
        self.llm_client = None
        
        # å¯¹è¯ç¼“å†²åŒºï¼ˆæŒ‰ç”¨æˆ·åˆ†éš”ï¼‰
        self._buffers: Dict[str, List[Dict]] = {}
        self._turn_counters: Dict[str, int] = {}
        
        if config.backend == AnalyzerBackend.LLM:
            self._init_llm_client()
    
    def _init_llm_client(self):
        """åˆå§‹åŒ– LLM å®¢æˆ·ç«¯"""
        from ..utils import LLMClient
        self.llm_client = LLMClient(
            model=self.config.llm_model,
            api_key=self.config.llm_api_key,
            base_url=self.config.llm_base_url
        )
    
    def on_new_turn(
        self, 
        content: str, 
        role: str,
        user_id: str = "default"
    ) -> Optional[Dict[str, Any]]:
        """
        æ¯è½®å¯¹è¯åè°ƒç”¨ï¼Œè¿”å›åˆ†æç»“æœï¼ˆå¦‚æœè§¦å‘äº†åˆ†æï¼‰
        
        Returns:
            None - æœªè§¦å‘åˆ†æ
            Dict - åˆ†æç»“æœ {new_foreshadowings, potentially_resolved}
        """
        if self.config.backend == AnalyzerBackend.MANUAL:
            return None
        
        # æ·»åŠ åˆ°ç¼“å†²åŒº
        if user_id not in self._buffers:
            self._buffers[user_id] = []
            self._turn_counters[user_id] = 0
        
        self._buffers[user_id].append({
            'role': role,
            'content': content,
            'turn': self._turn_counters[user_id]
        })
        self._turn_counters[user_id] += 1
        
        # æ£€æŸ¥æ˜¯å¦è§¦å‘åˆ†æ
        if self._should_trigger_analysis(user_id):
            return self._run_analysis(user_id)
        
        return None
    
    def _should_trigger_analysis(self, user_id: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦åº”è¯¥è§¦å‘åˆ†æ"""
        turn_count = self._turn_counters.get(user_id, 0)
        # trigger_interval=1 è¡¨ç¤ºæ¯è½®éƒ½è§¦å‘ï¼Œ=10 è¡¨ç¤ºæ¯10è½®è§¦å‘ä¸€æ¬¡
        return turn_count > 0 and turn_count % self.config.trigger_interval == 0
    
    def trigger_manual_analysis(self, user_id: str = "default") -> Dict[str, Any]:
        """æ‰‹åŠ¨è§¦å‘åˆ†æï¼ˆä¾› API/UI è°ƒç”¨ï¼‰"""
        return self._run_analysis(user_id)
    
    def _run_analysis(self, user_id: str) -> Dict[str, Any]:
        """æ‰§è¡Œåˆ†æï¼ˆä»… LLM æ¨¡å¼ä¼šè°ƒç”¨ï¼‰"""
        if self.config.backend == AnalyzerBackend.LLM:
            return self._analyze_with_llm(user_id)
        return {'new_foreshadowings': [], 'potentially_resolved': []}
    
    def _analyze_with_llm(self, user_id: str) -> Dict[str, Any]:
        """ä½¿ç”¨ LLM åˆ†æ"""
        buffer = self._buffers.get(user_id, [])
        if not buffer:
            return {'new_foreshadowings': [], 'potentially_resolved': []}
        
        # æ„å»ºå¯¹è¯æ–‡æœ¬
        conversation = self._format_conversation(buffer[-self.config.max_context_turns:])
        
        # è·å–å½“å‰æ´»è·ƒçš„ä¼ç¬”
        active = self.tracker.get_active(user_id)
        active_text = self._format_active_foreshadowings(active)
        
        # æ„å»ºæç¤ºè¯
        prompt = self.ANALYSIS_PROMPT.format(
            active_foreshadowings=active_text or "ï¼ˆæš‚æ— ï¼‰",
            conversation=conversation
        )
        
        # è°ƒç”¨ LLM
        try:
            response = self.llm_client.chat(
                messages=[{"role": "user", "content": prompt}],
                temperature=0.3,  # ä½æ¸©åº¦ï¼Œæ›´ç¡®å®šæ€§
                response_format={"type": "json_object"}
            )
            result = self._parse_llm_response(response)
            
            # å¤„ç†ç»“æœ
            if self.config.auto_plant:
                for fsh in result.get('new_foreshadowings', []):
                    self.tracker.plant(
                        content=fsh['content'],
                        user_id=user_id,
                        importance=fsh.get('importance', 0.5),
                        related_entities=fsh.get('related_entities', [])
                    )
            
            # æ¸…ç©ºå·²åˆ†æçš„ç¼“å†²åŒº
            self._buffers[user_id] = []
            
            return result
            
        except Exception as e:
            print(f"[Recall] LLM ä¼ç¬”åˆ†æå¤±è´¥: {e}")
            return {'new_foreshadowings': [], 'potentially_resolved': [], 'error': str(e)}
    
    def _format_conversation(self, turns: List[Dict]) -> str:
        """æ ¼å¼åŒ–å¯¹è¯å†…å®¹"""
        lines = []
        for t in turns:
            role = "ç”¨æˆ·" if t['role'] == 'user' else "AI"
            lines.append(f"[{role}]: {t['content']}")
        return "\n\n".join(lines)
    
    def _format_active_foreshadowings(self, foreshadowings) -> str:
        """æ ¼å¼åŒ–æ´»è·ƒä¼ç¬”åˆ—è¡¨"""
        if not foreshadowings:
            return ""
        lines = []
        for f in foreshadowings:
            lines.append(f"- [{f.id}] {f.content} (é‡è¦æ€§: {f.importance})")
        return "\n".join(lines)
    
    def _parse_llm_response(self, response: str) -> Dict[str, Any]:
        """è§£æ LLM è¿”å›çš„ JSON"""
        import json
        try:
            # æå– JSONï¼ˆå¤„ç†å¯èƒ½çš„ markdown ä»£ç å—ï¼‰
            if "```json" in response:
                response = response.split("```json")[1].split("```")[0]
            elif "```" in response:
                response = response.split("```")[1].split("```")[0]
            return json.loads(response.strip())
        except:
            return {'new_foreshadowings': [], 'potentially_resolved': []}
```

---

#### ä»»åŠ¡ 1.3ï¼šé›†æˆåˆ°å¼•æ“å’Œ API

**æ–‡ä»¶**ï¼š`recall/engine.py` - æ·»åŠ åˆ†æå™¨

```python
class RecallEngine:
    def __init__(self, ..., foreshadowing_config: ForeshadowingAnalyzerConfig = None):
        # ç°æœ‰åˆå§‹åŒ–...
        
        # ä¼ç¬”åˆ†æå™¨
        fsh_config = foreshadowing_config or ForeshadowingAnalyzerConfig()
        self.foreshadowing_analyzer = ForeshadowingAnalyzer(
            config=fsh_config,
            tracker=self.foreshadowing_tracker
        )
    
    def add(self, content: str, role: str = "user", user_id: str = "default", ...):
        # ç°æœ‰é€»è¾‘...
        
        # æ–°å¢ï¼šè§¦å‘ä¼ç¬”åˆ†æ
        analysis_result = self.foreshadowing_analyzer.on_new_turn(
            content=content,
            role=role,
            user_id=user_id
        )
        
        # å¯é€‰ï¼šè¿”å›åˆ†æç»“æœ
        if analysis_result:
            result.foreshadowing_analysis = analysis_result
        
        return result
```

**æ–‡ä»¶**ï¼š`recall/server.py` - æ·»åŠ  API

```python
@app.post("/v1/foreshadowing/analyze", tags=["Foreshadowing"])
async def trigger_foreshadowing_analysis(
    user_id: str = Query(default="default")
):
    """æ‰‹åŠ¨è§¦å‘ä¼ç¬”åˆ†æ"""
    result = engine.foreshadowing_analyzer.trigger_manual_analysis(user_id)
    return result

@app.get("/v1/foreshadowing/config", tags=["Foreshadowing"])
async def get_foreshadowing_config():
    """è·å–ä¼ç¬”åˆ†æå™¨é…ç½®"""
    config = engine.foreshadowing_analyzer.config
    return {
        "backend": config.backend.value,
        "trigger_interval": config.trigger_interval,
        "llm_model": config.llm_model,
        "auto_plant": config.auto_plant,
        "auto_resolve": config.auto_resolve
    }

@app.put("/v1/foreshadowing/config", tags=["Foreshadowing"])
async def update_foreshadowing_config(
    trigger_interval: int = Query(default=None),
    auto_plant: bool = Query(default=None)
):
    """æ›´æ–°ä¼ç¬”åˆ†æå™¨é…ç½®"""
    if trigger_interval is not None:
        engine.foreshadowing_analyzer.config.trigger_interval = trigger_interval
    if auto_plant is not None:
        engine.foreshadowing_analyzer.config.auto_plant = auto_plant
    return {"status": "ok"}
```

---

#### ä»»åŠ¡ 1.4ï¼šSillyTavern æ’ä»¶é›†æˆ

**æ›´æ–°è®¾ç½®é¢æ¿**ï¼š
```javascript
// ä¼ç¬”åˆ†æè®¾ç½®
<div class="recall-setting">
    <label>ä¼ç¬”è‡ªåŠ¨åˆ†æ</label>
    <select id="recall-foreshadowing-backend">
        <option value="manual" selected>æ‰‹åŠ¨æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰</option>
        <option value="llm">LLM æ™ºèƒ½åˆ†æ</option>
    </select>
</div>
<div class="recall-setting">
    <label>åˆ†æé—´éš”ï¼ˆæ¯Nè½®è§¦å‘ï¼‰</label>
    <input type="number" id="recall-foreshadowing-interval" value="10" min="1" max="100">
</div>
<div class="recall-setting">
    <label>
        <input type="checkbox" id="recall-foreshadowing-auto-plant" checked>
        è‡ªåŠ¨æ·»åŠ æ£€æµ‹åˆ°çš„ä¼ç¬”
    </label>
</div>
```

**æ˜¾ç¤ºåˆ†æç»“æœ**ï¼š
```javascript
// å½“æ”¶åˆ°åˆ†æç»“æœæ—¶ï¼Œæ˜¾ç¤ºé€šçŸ¥
function onForeshadowingAnalysis(result) {
    if (result.new_foreshadowings?.length > 0) {
        toastr.info(
            `å‘ç° ${result.new_foreshadowings.length} ä¸ªæ–°ä¼ç¬”`,
            'ğŸ­ ä¼ç¬”åˆ†æ'
        );
        loadForeshadowings(); // åˆ·æ–°åˆ—è¡¨
    }
    if (result.potentially_resolved?.length > 0) {
        toastr.warning(
            `${result.potentially_resolved.length} ä¸ªä¼ç¬”å¯èƒ½å·²è§£å†³`,
            'ğŸ­ ä¼ç¬”åˆ†æ'
        );
    }
}
```

---

### é˜¶æ®µä¸€ç‚¹äº”ï¼šè§„åˆ™ç¼–è¯‘å™¨ï¼ˆä¼˜å…ˆçº§ï¼šğŸŸ¡ ä¸­ï¼‰

**é¢„è®¡å·¥ä½œé‡**ï¼š1-2å¤©

> ğŸ’¡ **èƒŒæ™¯**ï¼šå½“å‰ `ConsistencyChecker` å·²å®ç° L0 æ³¨å…¥å’ŒåŸºç¡€å±æ€§æ£€æŸ¥ï¼Œä½†ç¼ºå°‘å°†è‡ªç„¶è¯­è¨€è§„åˆ™ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ£€æŸ¥çš„èƒ½åŠ›ã€‚

---

#### å½“å‰çŠ¶æ€ vs ç›®æ ‡

| åŠŸèƒ½ | å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ |
|------|:--------:|:--------:|
| L0 æ ¸å¿ƒè®¾å®šæ³¨å…¥ | âœ… | âœ… |
| ç»å¯¹è§„åˆ™å­˜å‚¨ | âœ… å­—ç¬¦ä¸²åˆ—è¡¨ | âœ… ç»“æ„åŒ–è§„åˆ™å¯¹è±¡ |
| æ•°å€¼å±æ€§æ£€æŸ¥ | âœ… å¹´é¾„/èº«é«˜ç­‰ | âœ… |
| **è§„åˆ™â†’æ£€æŸ¥é€»è¾‘** | âŒ ä»…å…³é”®è¯åŒ¹é… | âœ… è¯­ä¹‰ç†è§£æ£€æŸ¥ |
| **å…³ç³»å±æ€§æ£€æŸ¥** | âŒ | âœ… "Aå’ŒBæ˜¯æ•Œäºº" |
| **å¦å®šå¥æ£€æµ‹** | ğŸ”§ ç®€åŒ– | âœ… å®Œæ•´æ£€æµ‹ |

---

#### ä»»åŠ¡ 1.5.1ï¼šå®šä¹‰ç»“æ„åŒ–è§„åˆ™ç±»å‹

**æ–‡ä»¶**ï¼š`recall/processor/rule_compiler.py`

```python
from dataclasses import dataclass, field
from enum import Enum
from typing import List, Optional, Any, Callable

class RuleType(Enum):
    """è§„åˆ™ç±»å‹"""
    PROHIBITION = "prohibition"      # ç¦æ­¢ï¼šè§’è‰²ä¸ä¼šåšæŸäº‹
    REQUIREMENT = "requirement"      # å¿…é¡»ï¼šè§’è‰²å¿…é¡»éµå®ˆæŸäº‹
    RELATIONSHIP = "relationship"    # å…³ç³»ï¼šAå’ŒBçš„å…³ç³»æ˜¯X
    ATTRIBUTE = "attribute"          # å±æ€§ï¼šè§’è‰²Açš„å±æ€§Xæ˜¯Y
    CONDITION = "condition"          # æ¡ä»¶ï¼šå¦‚æœXåˆ™Y

@dataclass
class CompiledRule:
    """ç¼–è¯‘åçš„è§„åˆ™"""
    id: str
    original_text: str              # åŸå§‹è‡ªç„¶è¯­è¨€
    rule_type: RuleType
    
    # è§„åˆ™å‚æ•°
    subject: str = ""               # ä¸»ä½“ï¼ˆè§’è‰²åï¼‰
    action: str = ""                # åŠ¨ä½œ/å±æ€§
    object: str = ""                # å®¾è¯­
    value: Any = None               # å€¼
    
    # ç¼–è¯‘äº§ç‰©
    keywords: List[str] = field(default_factory=list)  # å…³é”®è¯
    patterns: List[str] = field(default_factory=list)  # æ­£åˆ™æ¨¡å¼
    check_func: Optional[Callable] = None              # æ£€æŸ¥å‡½æ•°
    
    # å…ƒä¿¡æ¯
    severity: str = "HIGH"          # è¿åä¸¥é‡ç¨‹åº¦
    enabled: bool = True


class RuleCompiler:
    """è§„åˆ™ç¼–è¯‘å™¨ - å°†è‡ªç„¶è¯­è¨€è§„åˆ™è½¬æ¢ä¸ºå¯æ‰§è¡Œæ£€æŸ¥"""
    
    def __init__(self):
        # è§„åˆ™æ¨¡å¼åº“
        self._patterns = {
            # ç¦æ­¢ç±»ï¼šä¸/ä¸ä¼š/ä¸èƒ½/ç¦æ­¢/ç»ä¸
            'prohibition': [
                r'(.+?)(ä¸ä¼š?|ä¸èƒ½|ç¦æ­¢|ç»ä¸|ä»ä¸)(.+)',
                r'(.+?)(æ°¸è¿œä¸|å†³ä¸)(.+)',
            ],
            # å¿…é¡»ç±»ï¼šå¿…é¡»/ä¸€å®š/æ€»æ˜¯
            'requirement': [
                r'(.+?)(å¿…é¡»|ä¸€å®šè¦?|æ€»æ˜¯|å§‹ç»ˆ)(.+)',
            ],
            # å…³ç³»ç±»ï¼šAå’ŒBæ˜¯/Aä¸Bçš„å…³ç³»
            'relationship': [
                r'(.+?)(å’Œ|ä¸)(.+?)(æ˜¯|ä¸º)(.+)',
                r'(.+?)(å’Œ|ä¸)(.+?)çš„å…³ç³»æ˜¯(.+)',
            ],
            # å±æ€§ç±»ï¼šAçš„Xæ˜¯Y
            'attribute': [
                r'(.+?)çš„(.+?)(æ˜¯|ä¸º)(.+)',
            ],
        }
    
    def compile(self, rule_text: str) -> CompiledRule:
        """å°†è‡ªç„¶è¯­è¨€è§„åˆ™ç¼–è¯‘ä¸ºç»“æ„åŒ–è§„åˆ™"""
        import re
        import hashlib
        
        rule_id = f"rule_{hashlib.md5(rule_text.encode()).hexdigest()[:8]}"
        
        # å°è¯•åŒ¹é…å„ç§æ¨¡å¼
        for rule_type, patterns in self._patterns.items():
            for pattern in patterns:
                match = re.match(pattern, rule_text)
                if match:
                    return self._build_rule(rule_id, rule_text, rule_type, match)
        
        # æœªåŒ¹é…åˆ°æ¨¡å¼ï¼Œä½œä¸ºé€šç”¨è§„åˆ™å¤„ç†
        return CompiledRule(
            id=rule_id,
            original_text=rule_text,
            rule_type=RuleType.PROHIBITION,  # é»˜è®¤å½“ä½œç¦æ­¢è§„åˆ™
            keywords=self._extract_keywords(rule_text),
        )
    
    def _build_rule(self, rule_id: str, text: str, rule_type: str, match) -> CompiledRule:
        """æ ¹æ®åŒ¹é…ç»“æœæ„å»ºè§„åˆ™"""
        groups = match.groups()
        
        if rule_type == 'prohibition':
            return CompiledRule(
                id=rule_id,
                original_text=text,
                rule_type=RuleType.PROHIBITION,
                subject=groups[0].strip(),
                action=groups[2].strip() if len(groups) > 2 else "",
                keywords=self._extract_keywords(text),
                patterns=self._generate_violation_patterns(groups[0], groups[2] if len(groups) > 2 else ""),
            )
        
        elif rule_type == 'relationship':
            return CompiledRule(
                id=rule_id,
                original_text=text,
                rule_type=RuleType.RELATIONSHIP,
                subject=groups[0].strip(),
                object=groups[2].strip(),
                value=groups[-1].strip(),
                keywords=[groups[0].strip(), groups[2].strip(), groups[-1].strip()],
            )
        
        elif rule_type == 'attribute':
            return CompiledRule(
                id=rule_id,
                original_text=text,
                rule_type=RuleType.ATTRIBUTE,
                subject=groups[0].strip(),
                action=groups[1].strip(),  # å±æ€§å
                value=groups[-1].strip(),
                keywords=[groups[0].strip(), groups[1].strip()],
            )
        
        # é»˜è®¤
        return CompiledRule(
            id=rule_id,
            original_text=text,
            rule_type=RuleType.REQUIREMENT,
            keywords=self._extract_keywords(text),
        )
    
    def _extract_keywords(self, text: str) -> List[str]:
        """ä»æ–‡æœ¬æå–å…³é”®è¯"""
        import re
        keywords = re.findall(r'[\u4e00-\u9fa5]{2,}|[a-zA-Z]+', text)
        # è¿‡æ»¤åœç”¨è¯
        stopwords = {'ä¸ä¼š', 'ä¸èƒ½', 'å¿…é¡»', 'ä¸€å®š', 'æ€»æ˜¯', 'çš„', 'æ˜¯', 'å’Œ', 'ä¸'}
        return [k for k in keywords if k not in stopwords]
    
    def _generate_violation_patterns(self, subject: str, action: str) -> List[str]:
        """ç”Ÿæˆè¿è§„æ£€æµ‹æ­£åˆ™æ¨¡å¼"""
        patterns = []
        if action:
            # "æ€äºº" -> æ£€æµ‹ "æ€äº†äºº", "æ€æ­»äº†", "æ­£åœ¨æ€"
            patterns.extend([
                f'{subject}.*{action}äº†',
                f'{subject}.*æ­£åœ¨{action}',
                f'{subject}.*å¼€å§‹{action}',
                f'{action}äº†.*{subject}',  # è¢«åŠ¨å¥
            ])
        return patterns
```

---

#### ä»»åŠ¡ 1.5.2ï¼šå¢å¼º ConsistencyChecker

**æ–‡ä»¶**ï¼š`recall/processor/consistency.py` - æ·»åŠ ç¼–è¯‘å™¨é›†æˆ

```python
from .rule_compiler import RuleCompiler, CompiledRule, RuleType

class ConsistencyChecker:
    def __init__(self, core_settings: 'CoreSettings', memory: 'ConsolidatedMemory'):
        self.core = core_settings
        self.memory = memory
        self.rule_compiler = RuleCompiler()  # æ–°å¢
        
        # ç¼–è¯‘æ ¸å¿ƒè®¾å®šä¸­çš„è§„åˆ™
        self._compiled_rules: List[CompiledRule] = self._compile_all_rules()
    
    def _compile_all_rules(self) -> List[CompiledRule]:
        """ç¼–è¯‘æ‰€æœ‰è§„åˆ™"""
        rules = []
        
        # ç¼–è¯‘ç»å¯¹è§„åˆ™
        if self.core.absolute_rules:
            for rule_text in self.core.absolute_rules:
                compiled = self.rule_compiler.compile(rule_text)
                rules.append(compiled)
        
        # ä»è§’è‰²å¡æå–å±æ€§è§„åˆ™
        if self.core.character_card:
            attr_rules = self._extract_attribute_rules(self.core.character_card)
            rules.extend(attr_rules)
        
        return rules
    
    def check_output(self, ai_output: str, context: dict) -> ConsistencyResult:
        """æ£€æŸ¥ AI è¾“å‡ºæ˜¯å¦è¿åè§„åˆ™"""
        violations = []
        
        for rule in self._compiled_rules:
            violation = self._check_rule(ai_output, rule)
            if violation:
                violations.append(violation)
        
        # ... å…¶ä»–æ£€æŸ¥é€»è¾‘
        
        return ConsistencyResult(
            is_consistent=len(violations) == 0,
            violations=violations,
            suggested_fixes=self._suggest_fixes(violations),
        )
    
    def _check_rule(self, output: str, rule: CompiledRule) -> Optional[Violation]:
        """æ£€æŸ¥å•æ¡è§„åˆ™"""
        import re
        
        if rule.rule_type == RuleType.PROHIBITION:
            # æ£€æŸ¥ç¦æ­¢è§„åˆ™
            for pattern in rule.patterns:
                if re.search(pattern, output):
                    return Violation(
                        type='RULE_VIOLATION',
                        rule=rule.original_text,
                        severity='CRITICAL',
                        evidence=output[:100],
                    )
        
        elif rule.rule_type == RuleType.RELATIONSHIP:
            # æ£€æŸ¥å…³ç³»æ˜¯å¦è¢«å¦å®š
            # å¦‚è§„åˆ™ï¼š"Aå’ŒBæ˜¯æ•Œäºº"ï¼Œæ£€æµ‹"Aå’ŒBæˆä¸ºäº†æœ‹å‹"
            # å®ç°ï¼šæ£€æŸ¥æ˜¯å¦æœ‰çŸ›ç›¾å…³ç³»æè¿°
            contradictions = self._find_relationship_contradiction(
                output, rule.subject, rule.object, rule.value
            )
            if contradictions:
                return Violation(
                    type='RELATIONSHIP_VIOLATION',
                    rule=rule.original_text,
                    severity='HIGH',
                    evidence=contradictions,
                )
        
        elif rule.rule_type == RuleType.ATTRIBUTE:
            # æ£€æŸ¥å±æ€§å†²çª
            conflict = self._find_attribute_conflict(
                output, rule.subject, rule.action, rule.value
            )
            if conflict:
                return Violation(
                    type='ATTRIBUTE_VIOLATION',
                    rule=rule.original_text,
                    severity='MEDIUM',
                    expected=rule.value,
                    found=conflict,
                )
        
        return None
    
    def _find_relationship_contradiction(
        self, text: str, subject: str, obj: str, relationship: str
    ) -> Optional[str]:
        """æŸ¥æ‰¾å…³ç³»çŸ›ç›¾"""
        # å…³ç³»å¯¹ç«‹è¯å…¸
        opposites = {
            'æ•Œäºº': ['æœ‹å‹', 'ç›Ÿå‹', 'æ‹äºº', 'åŒä¼´'],
            'æœ‹å‹': ['æ•Œäºº', 'ä»‡äºº', 'å¯¹æ‰‹'],
            'æ‹äºº': ['æ•Œäºº', 'é™Œç”Ÿäºº', 'ä»‡äºº'],
            'ä¸»äºº': ['å¥´éš¶', 'ä»†äºº'],  # å¦‚æœAæ˜¯Bçš„ä¸»äººï¼Œåˆ™Bä¸èƒ½æ˜¯Açš„ä¸»äºº
        }
        
        if relationship in opposites:
            for opposite in opposites[relationship]:
                # æ£€æŸ¥æ˜¯å¦æè¿°äº†ç›¸åå…³ç³»
                patterns = [
                    f'{subject}.*{obj}.*{opposite}',
                    f'{obj}.*{subject}.*{opposite}',
                    f'{subject}.*å’Œ.*{obj}.*æˆä¸º.*{opposite}',
                ]
                for p in patterns:
                    import re
                    if re.search(p, text):
                        return f"å‘ç°çŸ›ç›¾å…³ç³»: {opposite}"
        
        return None
    
    def _find_attribute_conflict(
        self, text: str, subject: str, attribute: str, expected_value: Any
    ) -> Optional[str]:
        """æŸ¥æ‰¾å±æ€§å†²çª"""
        import re
        
        # æ£€æŸ¥æ˜¯å¦å£°æ˜äº†ä¸åŒçš„å±æ€§å€¼
        pattern = rf'{subject}çš„{attribute}(æ˜¯|ä¸º|å˜æˆäº†?)(\S+)'
        match = re.search(pattern, text)
        if match:
            found_value = match.group(2)
            if found_value != expected_value:
                return found_value
        
        return None
```

---

#### ä»»åŠ¡ 1.5.3ï¼šAPI å’Œé…ç½®æ”¯æŒ

**æ–‡ä»¶**ï¼š`recall/server.py` - æ·»åŠ è§„åˆ™ç®¡ç† API

```python
@app.get("/v1/rules", tags=["Consistency"])
async def list_rules():
    """è·å–æ‰€æœ‰å·²ç¼–è¯‘çš„è§„åˆ™"""
    rules = engine.consistency_checker._compiled_rules
    return [
        {
            "id": r.id,
            "original": r.original_text,
            "type": r.rule_type.value,
            "subject": r.subject,
            "enabled": r.enabled,
        }
        for r in rules
    ]

@app.post("/v1/rules", tags=["Consistency"])
async def add_rule(rule_text: str = Body(...)):
    """æ·»åŠ æ–°è§„åˆ™"""
    compiled = engine.consistency_checker.rule_compiler.compile(rule_text)
    engine.consistency_checker._compiled_rules.append(compiled)
    engine.core_settings.absolute_rules.append(rule_text)
    return {"id": compiled.id, "type": compiled.rule_type.value}

@app.delete("/v1/rules/{rule_id}", tags=["Consistency"])
async def delete_rule(rule_id: str):
    """åˆ é™¤è§„åˆ™"""
    rules = engine.consistency_checker._compiled_rules
    engine.consistency_checker._compiled_rules = [r for r in rules if r.id != rule_id]
    return {"status": "deleted"}

@app.post("/v1/check", tags=["Consistency"])
async def check_consistency(
    text: str = Body(..., embed=True)
):
    """æ£€æŸ¥æ–‡æœ¬æ˜¯å¦è¿åè§„åˆ™"""
    result = engine.consistency_checker.check_output(text, {})
    return {
        "is_consistent": result.is_consistent,
        "violations": [
            {
                "type": v.type,
                "rule": v.rule,
                "severity": v.severity,
                "evidence": v.evidence,
            }
            for v in result.violations
        ]
    }
```

---

#### ä»»åŠ¡ 1.5.4ï¼šSillyTavern æ’ä»¶é›†æˆ

**æ›´æ–°è®¾ç½®é¢æ¿**ï¼š
```javascript
// è§„åˆ™ç®¡ç†åŒºåŸŸ
<div class="recall-section">
    <h4>ğŸ“‹ è§’è‰²è§„åˆ™</h4>
    <div id="recall-rules-list"></div>
    <div class="recall-rule-input">
        <input type="text" id="recall-new-rule" placeholder="è¾“å…¥è§„åˆ™ï¼Œå¦‚ï¼šè§’è‰²ä¸ä¼šæ€äºº">
        <button id="recall-add-rule">æ·»åŠ </button>
    </div>
</div>

// è§„åˆ™åˆ—è¡¨å±•ç¤º
function loadRules() {
    fetch(`${RECALL_API}/v1/rules`)
        .then(r => r.json())
        .then(rules => {
            const html = rules.map(r => `
                <div class="recall-rule-item" data-id="${r.id}">
                    <span class="rule-type">[${r.type}]</span>
                    <span class="rule-text">${r.original}</span>
                    <button class="delete-rule">ğŸ—‘ï¸</button>
                </div>
            `).join('');
            document.getElementById('recall-rules-list').innerHTML = html;
        });
}
```

---

#### éªŒæ”¶æ ‡å‡†

| æµ‹è¯•åœºæ™¯ | è¾“å…¥è§„åˆ™ | æµ‹è¯•è¾“å‡º | é¢„æœŸç»“æœ |
|----------|---------|----------|----------|
| ç¦æ­¢è§„åˆ™ | "è§’è‰²ä¸ä¼šæ€äºº" | "è§’è‰²æ€æ­»äº†æ•Œäºº" | âš ï¸ è¿è§„ |
| ç¦æ­¢è§„åˆ™ | "è§’è‰²ä¸ä¼šæ€äºº" | "è§’è‰²æ‰“ä¼¤äº†æ•Œäºº" | âœ… é€šè¿‡ |
| å…³ç³»è§„åˆ™ | "Aå’ŒBæ˜¯æ•Œäºº" | "Aå’ŒBæˆä¸ºäº†æœ‹å‹" | âš ï¸ è¿è§„ |
| å…³ç³»è§„åˆ™ | "Aå’ŒBæ˜¯æ•Œäºº" | "Aå’ŒBç»§ç»­å¯¹å³™" | âœ… é€šè¿‡ |
| å±æ€§è§„åˆ™ | "è§’è‰²çš„å‘è‰²æ˜¯é»‘è‰²" | "è§’è‰²çš„é‡‘è‰²é•¿å‘" | âš ï¸ è¿è§„ |

---

### é˜¶æ®µäºŒï¼šCodeIndexerï¼ˆä¼˜å…ˆçº§ï¼šğŸŸ¢ ä½ï¼‰

**é¢„è®¡å·¥ä½œé‡**ï¼š2-3å¤©

**å»ºè®®**ï¼šæ­¤åŠŸèƒ½é¢å‘ä»£ç åœºæ™¯ï¼Œå¦‚æœ v3.0 ä¸»è¦é¢å‘ RP åœºæ™¯ï¼Œå¯ä»¥ï¼š
1. æ ‡è®°ä¸º v3.1 ç‰ˆæœ¬çš„åŠŸèƒ½
2. æˆ–è€…ä»è®¡åˆ’æ–‡æ¡£ä¸­ç§»é™¤æ­¤éœ€æ±‚

å¦‚æœéœ€è¦å®ç°ï¼Œè®¡åˆ’å¦‚ä¸‹ï¼š

#### ä»»åŠ¡ 2.1ï¼šåˆ›å»ºåŸºç¡€ç»“æ„

**æ–‡ä»¶**ï¼š`recall/processor/code_indexer.py`

```python
class CodeIndexer:
    """ä»£ç ç´¢å¼•å™¨"""
    
    SUPPORTED_LANGUAGES = {
        '.py': 'python',
        '.js': 'javascript',
        '.ts': 'typescript',
        '.java': 'java',
        '.go': 'go',
    }
    
    def __init__(self, data_path: str):
        self.data_path = data_path
        self.symbol_table: Dict[str, Symbol] = {}
        self.dependency_graph: Dict[str, List[str]] = {}
    
    def index_file(self, file_path: str) -> None: ...
    def index_directory(self, dir_path: str) -> None: ...
    def search_symbol(self, name: str) -> List[Symbol]: ...
    def get_dependencies(self, file_path: str) -> List[str]: ...
```

#### ä»»åŠ¡ 2.2ï¼šå®ç° Python è§£æå™¨

ä½¿ç”¨ `ast` æ¨¡å—è§£æ Python ä»£ç ã€‚

#### ä»»åŠ¡ 2.3ï¼šå®ç° JavaScript è§£æå™¨

å¯ä»¥ä½¿ç”¨æ­£åˆ™æˆ–ç®€å•çš„è§£æå™¨ã€‚

---

## äº”ã€ä¼˜å…ˆçº§å’Œæ—¶é—´çº¿

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | å»ºè®®æ’æœŸ |
|:------:|------|:--------:|---------|
| ğŸ”´ P0 | ForeshadowingAnalyzer é…ç½®ç±» | 0.5å¤© | ç¬¬1å¤© |
| ğŸ”´ P0 | LLM åˆ†æåç«¯å®ç° | 1å¤© | ç¬¬1-2å¤© |
| ğŸŸ  P1 | é›†æˆåˆ° Engine å’Œ Server API | 0.5å¤© | ç¬¬2å¤© |
| ğŸŸ  P1 | SillyTavern æ’ä»¶è®¾ç½®é¢æ¿ | 0.5å¤© | ç¬¬2å¤© |
| ğŸŸ¡ P1.5 | RuleCompiler è§„åˆ™ç¼–è¯‘å™¨ | 0.5å¤© | ç¬¬3å¤© |
| ğŸŸ¡ P1.5 | ConsistencyChecker å¢å¼º | 0.5å¤© | ç¬¬3å¤© |
| ğŸŸ¡ P1.5 | è§„åˆ™ç®¡ç† API å’Œæ’ä»¶é›†æˆ | 0.5å¤© | ç¬¬3-4å¤© |
| ğŸŸ¢ P2 | CodeIndexerï¼ˆå¯é€‰ï¼‰ | 2-3å¤© | v3.1 |

---

## å…­ã€é…ç½®ç¤ºä¾‹

### ç”¨æˆ·é…ç½®æ–‡ä»¶ `recall_data/config.json`

```json
{
  "foreshadowing": {
    "backend": "manual",
    "trigger_interval": 10,
    "llm_model": "gpt-4o-mini",
    "auto_plant": true,
    "auto_resolve": false
  }
}
```

> ğŸ’¡ **é»˜è®¤è¡Œä¸º**ï¼š`backend: "none"` è¡¨ç¤ºæ‰‹åŠ¨æ¨¡å¼ï¼Œç”¨æˆ·è‡ªå·±ç®¡ç†ä¼ç¬”ã€‚
> é…ç½® LLM API åå¯æ”¹ä¸º `"llm"` å¯ç”¨è‡ªåŠ¨åˆ†æã€‚

### ä»£ç ä½¿ç”¨ç¤ºä¾‹

```python
from recall import RecallEngine
from recall.processor import ForeshadowingAnalyzerConfig

# æ–¹å¼1ï¼šé»˜è®¤æ‰‹åŠ¨æ¨¡å¼ï¼ˆæ— éœ€é…ç½®ï¼Œç”¨æˆ·è‡ªå·±ç®¡ç†ä¼ç¬”ï¼‰
engine = RecallEngine()  # backend = MANUAL

# æ–¹å¼2ï¼šå¯ç”¨ LLM è‡ªåŠ¨åˆ†æï¼ˆéœ€è¦ API keyï¼‰
engine = RecallEngine(
    foreshadowing_config=ForeshadowingAnalyzerConfig.llm_based(
        api_key="sk-xxx",
        model="gpt-4o-mini",
        trigger_interval=10  # æ¯10è½®åˆ†æä¸€æ¬¡
    )
)
```

---

## ä¸ƒã€éªŒæ”¶æ ‡å‡†

### ä¼ç¬”è‡ªåŠ¨æ£€æµ‹åŠŸèƒ½éªŒæ”¶

**LLM åç«¯**ï¼š
- [ ] é…ç½® `trigger_interval=10` åï¼Œç¬¬10è½®å¯¹è¯è‡ªåŠ¨è§¦å‘åˆ†æ
- [ ] LLM èƒ½æ­£ç¡®è¯†åˆ«å¯¹è¯ä¸­çš„ä¼ç¬”ï¼ˆå¦‚"æ€»æœ‰ä¸€å¤©ä¼šæ­æ™“çœŸç›¸"ï¼‰
- [ ] LLM èƒ½è¯†åˆ«å·²æœ‰ä¼ç¬”æ˜¯å¦è¢«è§£å†³
- [ ] è¿”å›ç»“æœä¸º JSON æ ¼å¼ï¼ŒåŒ…å« `new_foreshadowings` å’Œ `potentially_resolved`
- [ ] `auto_plant=true` æ—¶ï¼Œè‡ªåŠ¨æ·»åŠ åˆ°ä¼ç¬”åˆ—è¡¨
- [ ] `auto_resolve=false` æ—¶ï¼Œåªæç¤ºä¸è‡ªåŠ¨è§£å†³

**API**ï¼š
- [ ] `POST /v1/foreshadowing/analyze` æ‰‹åŠ¨è§¦å‘åˆ†æ
- [ ] `GET /v1/foreshadowing/config` è·å–é…ç½®
- [ ] `PUT /v1/foreshadowing/config` æ›´æ–°é…ç½®

**SillyTavern æ’ä»¶**ï¼š
- [ ] è®¾ç½®é¢æ¿æ˜¾ç¤ºä¼ç¬”åˆ†æé€‰é¡¹
- [ ] ç”¨æˆ·å¯é€‰æ‹© ç¦ç”¨/è§„åˆ™/LLM ä¸‰ç§æ¨¡å¼
- [ ] ç”¨æˆ·å¯è®¾ç½®è§¦å‘é—´éš”
- [ ] åˆ†æå®Œæˆåæ˜¾ç¤ºé€šçŸ¥
- [ ] ä¼ç¬”åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°

### CodeIndexer åŠŸèƒ½éªŒæ”¶ï¼ˆå¦‚æœå®ç°ï¼‰

- [ ] èƒ½ç´¢å¼• Python æ–‡ä»¶ä¸­çš„å‡½æ•°ã€ç±»ã€å˜é‡
- [ ] èƒ½åˆ†æ import è¯­å¥æ„å»ºä¾èµ–å›¾
- [ ] èƒ½æœç´¢ç¬¦å·åè¿”å›å®šä¹‰ä½ç½®

---

## å…«ã€æˆæœ¬ä¼°ç®—ï¼ˆLLM åç«¯ï¼‰

| é…ç½® | æ¯æ¬¡åˆ†æ Token | æ¯10è½®æˆæœ¬ | æ¯100è½®æˆæœ¬ |
|------|:-------------:|:----------:|:-----------:|
| gpt-4o-mini | ~2000 | ~$0.001 | ~$0.01 |
| gpt-4o | ~2000 | ~$0.02 | ~$0.20 |
| claude-3-haiku | ~2000 | ~$0.001 | ~$0.01 |

> ğŸ’¡ **æ¨è**ï¼šä½¿ç”¨ `gpt-4o-mini` æˆ– `claude-3-haiku`ï¼Œæˆæœ¬æä½ä¸”æ•ˆæœè¶³å¤Ÿå¥½ã€‚

---

## ä¹ã€ç»“è®º

å½“å‰é¡¹ç›®å·²å®ç° **96%** çš„åŠŸèƒ½ï¼ˆ27/28é¡¹ âœ…ï¼‰ï¼Œæ ¸å¿ƒæ¶æ„å®Œæ•´ã€‚

### åŠŸèƒ½ç»Ÿè®¡

| åˆ†ç»„ | é¡¹ç›®æ•° | å®Œæˆæ•° | çŠ¶æ€ |
|------|:------:|:------:|:----:|
| ç¬¬ä¸€ç»„ï¼šæ ¸å¿ƒåŠŸèƒ½éœ€æ±‚ | 15 | 14âœ… + 1âŒ | 93% |
| ç¬¬äºŒç»„ï¼šå³æ’å³ç”¨/ç¯å¢ƒéš”ç¦» | 10 | 10âœ… | 100% |
| ç¬¬ä¸‰ç»„ï¼šè®¡åˆ’å¤–æ–°å¢åŠŸèƒ½â­ | 3 | 3âœ… | 100% |
| **æ€»è®¡** | **28** | **27âœ… + 1âŒ** | **96%** |

### å¾…å®Œæˆå·¥ä½œ

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ | å·¥ä½œé‡ | ä¼˜å…ˆçº§ |
|------|:----:|------|:------:|:------:|
| CodeIndexer | âŒ æœªå®ç° | æ•´ä¸ªæ¨¡å—ï¼ˆä»£ç åœºæ™¯ä¸“ç”¨ï¼ŒRPå¯é€‰ï¼‰ | 2-3å¤© | ğŸŸ¢ ä½ |

### å¯é€‰å¢å¼ºé¡¹ï¼ˆéå¿…é¡»ï¼‰

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ | å·¥ä½œé‡ | ä¼˜å…ˆçº§ |
|------|:----:|------|:------:|:------:|
| è­¦å‘Šå†å²è®°å½• | ï¿½ å¯é€‰ | toastræ¶ˆå¤±åæ— æ³•æŸ¥çœ‹å†å² | 0.5å¤© | ğŸŸ¢ ä½ |
| æµ‹è¯•è§„åˆ™åŠŸèƒ½ | ğŸŸ¡ å¯é€‰ | éªŒè¯è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆçš„UI | 1å¤© | ğŸŸ¢ ä½ |

### å¯¹ RP åœºæ™¯çš„å®é™…å½±å“

| åŠŸèƒ½ | å½±å“ç¨‹åº¦ | è¯´æ˜ |
|------|:-------:|------|
| ~~ä¼ç¬”è‡ªåŠ¨æ£€æµ‹~~ | âœ… | **å·²å®ç°**ï¼Œæ”¯æŒæ‰‹åŠ¨+LLMä¸¤ç§æ¨¡å¼ |
| è§„èŒƒ100%éµå®ˆ | âœ… | **å…¨éƒ¨å®ç°**ï¼ˆ2026-01-24ï¼‰<br>è‡ªåŠ¨å±æ€§æ£€æµ‹âœ… + ç”¨æˆ·è§„åˆ™æ£€æµ‹âœ… |
| CodeIndexer | æ—  | ä»£ç åœºæ™¯ä¸“ç”¨ï¼ŒRPä¸éœ€è¦ |

### è§„èŒƒ100%éµå®ˆåŠŸèƒ½è¯¦ç»†è¯´æ˜

**å·²å®ç°ï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼Œæ— éœ€ç”¨æˆ·é…ç½®ï¼‰**ï¼š
- âœ… å±æ€§å†²çªæ£€æµ‹ï¼šé»‘å‘â†’é‡‘å‘ ä¼šè­¦å‘Š
- âœ… å…³ç³»å†²çªæ£€æµ‹ï¼šæœ‹å‹â†’æ•Œäºº ä¼šè­¦å‘Š  
- âœ… çŠ¶æ€å†²çªæ£€æµ‹ï¼šæ­»äº†â†’æ´»ç€ ä¼šè­¦å‘Š
- âœ… æ—¶é—´çº¿å†²çªæ£€æµ‹ï¼šå¹´é¾„ä¸ä¸€è‡´ ä¼šè­¦å‘Š
- âœ… å‰ç«¯ toastr å¼¹çª—æ˜¾ç¤ºè­¦å‘Š

**å·²å®ç°ï¼ˆç”¨æˆ·é…ç½®çš„ç»å¯¹è§„åˆ™ - LLMè¯­ä¹‰æ£€æµ‹ï¼‰**ï¼ˆ2026-01-24æ–°å¢ï¼‰ï¼š
- âœ… ç”¨æˆ·åœ¨å‰ç«¯ã€Œâš ï¸ è§„åˆ™ã€æ·»åŠ çš„ç»å¯¹è§„åˆ™**ç°å·²ç”Ÿæ•ˆ**
- âœ… ä½¿ç”¨ **LLM è¯­ä¹‰ç†è§£**ï¼Œæ”¯æŒä»»æ„å¤æ‚çš„è‡ªç„¶è¯­è¨€è§„åˆ™
- âœ… ä¾‹ï¼šã€Œè§’è‰²æ¸©æŸ”å–„è‰¯ã€â†’ LLMæ£€æµ‹"ç‹ ç‹ åœ°è¸¢"å±äºè¿å
- âœ… ä¾‹ï¼šã€Œæ•…äº‹èƒŒæ™¯æ˜¯å¤ä»£ã€â†’ LLMæ£€æµ‹"æ‰‹æœº/æ±½è½¦"å±äºè¿å
- âš ï¸ **æ³¨æ„ï¼šéœ€è¦é…ç½® LLM_API_KEY æ‰èƒ½ç”Ÿæ•ˆ**ï¼ˆæ— LLMæ—¶åŠŸèƒ½ä¸ç”Ÿæ•ˆï¼‰

**å¯é€‰å¢å¼º**ï¼ˆéå¿…é¡»ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰ï¼š
- ğŸŸ¡ è­¦å‘Šå¼¹çª—æ¶ˆå¤±åæŸ¥çœ‹å†å²ï¼ˆå¯é€‰ï¼‰
- ğŸŸ¡ "æµ‹è¯•è§„åˆ™"åŠŸèƒ½éªŒè¯è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆï¼ˆå¯é€‰ï¼‰

### æ–°æ–¹æ¡ˆä¼˜åŠ¿

é‡‡ç”¨ **LLM API åç«¯** æ–¹æ¡ˆæ›¿ä»£åŸè®¡åˆ’çš„è§„åˆ™åŒ¹é…ï¼š

| å¯¹æ¯”é¡¹ | è§„åˆ™åŒ¹é…æ–¹æ¡ˆ | LLM API æ–¹æ¡ˆ |
|--------|:----------:|:-----------:|
| å‡†ç¡®æ€§ | â­â­ | â­â­â­â­â­ |
| è¯­ä¹‰ç†è§£ | âŒ | âœ… |
| éšå«ä¼ç¬”è¯†åˆ« | âŒ | âœ… |
| æˆæœ¬ | å…è´¹ | æä½ï¼ˆ~$0.01/100è½®ï¼‰ |
| ç»´æŠ¤æˆæœ¬ | éœ€ç»´æŠ¤å…³é”®è¯åº“ | æ—  |
| å¤šè¯­è¨€æ”¯æŒ | éœ€åˆ†åˆ«é…ç½® | å¤©ç„¶æ”¯æŒ |

---

**å»ºè®®**ï¼š
1. **v3.0 å‘å¸ƒ**ï¼šå®Œæˆ `ForeshadowingAnalyzer` åå³å¯å‘å¸ƒ
2. **v3.1 å¢å¼º**ï¼šè§„åˆ™ç¼–è¯‘å™¨ + CodeIndexerï¼ˆæŒ‰éœ€ï¼‰
